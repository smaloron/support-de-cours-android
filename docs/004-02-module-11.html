<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2025-11-07T11:26:39.058975"><title>Module 11 : G&eacute;rer une Base de Donn&eacute;es Locale avec `Room` | Android</title><script type="application/json" id="virtual-toc-data">[{"id":"objectifs-p-dagogiques","level":0,"title":"Objectifs pédagogiques","anchor":"#objectifs-p-dagogiques"},{"id":"introduction","level":0,"title":"Introduction","anchor":"#introduction"},{"id":"notions-abord-es","level":0,"title":"Notions abordées","anchor":"#notions-abord-es"},{"id":"pourquoi-room-une-abstraction-au-dessus-de-sqlite","level":0,"title":"Pourquoi Room ? Une abstraction au-dessus de SQLite","anchor":"#pourquoi-room-une-abstraction-au-dessus-de-sqlite"},{"id":"les-3-piliers-de-room","level":0,"title":"Les 3 Piliers de Room","anchor":"#les-3-piliers-de-room"},{"id":"tp-11-une-application-de-prise-de-notes-simple","level":0,"title":"TP 11 : Une application de prise de notes simple","anchor":"#tp-11-une-application-de-prise-de-notes-simple"},{"id":"correction-du-tp-11","level":0,"title":"Correction du TP 11","anchor":"#correction-du-tp-11"},{"id":"auto-valuation","level":0,"title":"Auto-évaluation","anchor":"#auto-valuation"},{"id":"conclusion-du-module","level":0,"title":"Conclusion du module","anchor":"#conclusion-du-module"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.css" rel="stylesheet"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Module 11 : G&eacute;rer une Base de Donn&eacute;es Locale avec `Room` | Android"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="Android Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/004-02-module-11.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Module 11 : G&eacute;rer une Base de Donn&eacute;es Locale avec `Room` | Android"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/004-02-module-11.html#webpage",
    "url": "writerside-documentation/004-02-module-11.html",
    "name": "Module 11 : G&eacute;rer une Base de Donn&eacute;es Locale avec `Room` | Android",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "Android Help"
}</script><!-- End Schema.org --></head><body data-id="004-02-module-11" data-main-title="Module 11 : Gérer une Base de Données Locale avec `Room`" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="004-partie-04.md|Partie 4 : Gestion des Données"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>Android  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="004-02-module-11" id="004-02-module-11.md">Module 11 : Gérer une Base de Données Locale avec `Room`</h1><section class="chapter"><h2 id="objectifs-p-dagogiques" data-toc="objectifs-p-dagogiques">Objectifs p&eacute;dagogiques</h2><p id="-lasy6n_13">&Agrave; la fin de ce module, vous serez capable de :</p><ul class="list _bullet" id="-lasy6n_14"><li class="list__item" id="-lasy6n_15"><p id="-lasy6n_20">Expliquer pourquoi <code class="code" id="-lasy6n_21">Room</code> est la solution recommand&eacute;e pour la persistance de donn&eacute;es structur&eacute;es sur Android.</p></li><li class="list__item" id="-lasy6n_16"><p id="-lasy6n_22">Identifier et impl&eacute;menter les trois composants architecturaux de <code class="code" id="-lasy6n_23">Room</code>: <code class="code" id="-lasy6n_24">@Entity</code>, <code class="code" id="-lasy6n_25">@Dao</code>, et <code class="code" id="-lasy6n_26">@Database</code>.</p></li><li class="list__item" id="-lasy6n_17"><p id="-lasy6n_27">D&eacute;finir une table de base de donn&eacute;es &agrave; l'aide d'une <code class="code" id="-lasy6n_28">data class</code> et d'annotations.</p></li><li class="list__item" id="-lasy6n_18"><p id="-lasy6n_29">Cr&eacute;er des requ&ecirc;tes SQL (CRUD : Create, Read, Update, Delete) dans une interface DAO.</p></li><li class="list__item" id="-lasy6n_19"><p id="-lasy6n_30">Mettre en place et obtenir une instance de la base de donn&eacute;es.</p></li></ul></section><section class="chapter"><h2 id="introduction" data-toc="introduction">Introduction</h2><p id="-lasy6n_31">Imaginez que votre application ne g&egrave;re plus seulement quelques r&eacute;glages, mais une collection enti&egrave;re de livres. Vous avez des centaines de titres, d'auteurs, de dates de publication... Utiliser des &quot;post-its&quot; (<code class="code" id="-lasy6n_33">SharedPreferences</code>) serait un chaos total. Vous avez besoin d'une biblioth&egrave;que bien organis&eacute;e, avec des &eacute;tag&egrave;res (<code class="code" id="-lasy6n_34">Tables</code>), des fiches pour chaque livre (<code class="code" id="-lasy6n_35">Entit&eacute;s</code>), et un biblioth&eacute;caire (<code class="code" id="-lasy6n_36">DAO</code>) qui sait exactement o&ugrave; trouver un livre, comment en ajouter un nouveau ou en retirer un ancien.</p><p id="-lasy6n_32"><code class="code" id="-lasy6n_37">Room</code> est cette biblioth&egrave;que moderne et efficace pour votre application. C'est une couche d'abstraction au-dessus de la base de donn&eacute;es SQLite int&eacute;gr&eacute;e &agrave; Android. <code class="code" id="-lasy6n_38">Room</code> transforme la complexit&eacute; des requ&ecirc;tes SQL brutes en appels de fonctions Kotlin simples et s&eacute;curis&eacute;s, tout en v&eacute;rifiant votre SQL &agrave; la compilation pour vous &eacute;viter des erreurs &agrave; l'ex&eacute;cution. C'est la solution de r&eacute;f&eacute;rence pour toute persistance de donn&eacute;es structur&eacute;es.</p></section><section class="chapter"><h2 id="notions-abord-es" data-toc="notions-abord-es">Notions abord&eacute;es</h2><ul class="list _bullet" id="-lasy6n_39"><li class="list__item" id="-lasy6n_41"><p id="-lasy6n_43">Pourquoi Room ? Une abstraction au-dessus de SQLite.</p></li><li class="list__item" id="-lasy6n_42"><p id="-lasy6n_44">Les 3 Piliers de Room : <code class="code" id="-lasy6n_45">@Entity</code>, <code class="code" id="-lasy6n_46">@Dao</code>, <code class="code" id="-lasy6n_47">@Database</code>.</p></li></ul></section><section class="chapter"><h2 id="pourquoi-room-une-abstraction-au-dessus-de-sqlite" data-toc="pourquoi-room-une-abstraction-au-dessus-de-sqlite">Pourquoi Room ? Une abstraction au-dessus de SQLite</h2><section class="chapter"><h3 id="introduction-la-notion" data-toc="introduction-la-notion">Introduction &agrave; la notion</h3><p id="-lasy6n_50">SQLite est le moteur de base de donn&eacute;es int&eacute;gr&eacute; &agrave; chaque appareil Android. Il est puissant et fiable, mais son utilisation directe en Java/Kotlin est verbeuse et risqu&eacute;e. C'est comme parler directement le langage machine d'un ordinateur. <code class="code" id="-lasy6n_51">Room</code> est un traducteur intelligent qui vous permet de parler un langage de plus haut niveau (Kotlin), et il se charge de la traduction complexe et sans erreur vers SQLite.</p></section><section class="chapter"><h3 id="explication-de-la-notion" data-toc="explication-de-la-notion">Explication de la notion</h3><p id="-lasy6n_52">Utiliser l'API SQLite native (<code class="code" id="-lasy6n_57">SQLiteOpenHelper</code>) implique :</p><ul class="list _bullet" id="-lasy6n_53"><li class="list__item" id="-lasy6n_58"><p id="-lasy6n_61">&Eacute;crire des requ&ecirc;tes SQL sous forme de <code class="code" id="-lasy6n_62">String</code>, sans aucune v&eacute;rification par le compilateur. Une faute de frappe ne sera d&eacute;tect&eacute;e qu'au crash de l'application.</p></li><li class="list__item" id="-lasy6n_59"><p id="-lasy6n_63">Convertir manuellement les r&eacute;sultats des requ&ecirc;tes (objet <code class="code" id="-lasy6n_64">Cursor</code>) en objets Kotlin, ce qui est r&eacute;p&eacute;titif et source d'erreurs.</p></li><li class="list__item" id="-lasy6n_60"><p id="-lasy6n_65">G&eacute;rer manuellement les migrations de sch&eacute;ma de base de donn&eacute;es.</p></li></ul><p id="-lasy6n_54"><code class="code" id="-lasy6n_66">Room</code> r&eacute;sout tous ces probl&egrave;mes :</p><ul class="list _bullet" id="-lasy6n_55"><li class="list__item" id="-lasy6n_67"><p id="-lasy6n_70"><span class="control" id="-lasy6n_71">V&eacute;rification des requ&ecirc;tes &agrave; la compilation :</span> Room analyse votre SQL pendant que vous compilez votre projet et vous signale les erreurs de syntaxe.</p></li><li class="list__item" id="-lasy6n_68"><p id="-lasy6n_72"><span class="control" id="-lasy6n_73">Moins de code r&eacute;p&eacute;titif (<code class="code" id="-lasy6n_74">boilerplate</code>) :</span> Il mappe automatiquement les r&eacute;sultats des requ&ecirc;tes vers vos objets Kotlin.</p></li><li class="list__item" id="-lasy6n_69"><p id="-lasy6n_75"><span class="control" id="-lasy6n_76">Int&eacute;gration facile avec d'autres composants Jetpack :</span> Fonctionne parfaitement avec <code class="code" id="-lasy6n_77">LiveData</code>, <code class="code" id="-lasy6n_78">Flow</code> (pour des donn&eacute;es r&eacute;actives) et les Coroutines.</p></li></ul></section></section><section class="chapter"><h2 id="les-3-piliers-de-room" data-toc="les-3-piliers-de-room">Les 3 Piliers de Room</h2><section class="chapter"><h3 id="introduction-la-notion_1" data-toc="introduction-la-notion_1">Introduction &agrave; la notion</h3><p id="-lasy6n_82">Pour construire notre biblioth&egrave;que, nous avons besoin de trois plans de construction distincts mais connect&eacute;s :</p><ol class="list _decimal" id="-lasy6n_83" type="1"><li class="list__item" id="-lasy6n_84"><p id="-lasy6n_87">Le plan d'une <span class="control" id="-lasy6n_88">fiche de livre</span> (<code class="code" id="-lasy6n_89">@Entity</code>) : Il d&eacute;crit &agrave; quoi ressemble un livre (titre, auteur...).</p></li><li class="list__item" id="-lasy6n_85"><p id="-lasy6n_90">Le plan du <span class="control" id="-lasy6n_91">comptoir du biblioth&eacute;caire</span> (<code class="code" id="-lasy6n_92">@Dao</code>) : Il liste toutes les op&eacute;rations possibles (chercher un livre, ajouter un livre...).</p></li><li class="list__item" id="-lasy6n_86"><p id="-lasy6n_93">Le plan de la <span class="control" id="-lasy6n_94">biblioth&egrave;que elle-m&ecirc;me</span> (<code class="code" id="-lasy6n_95">@Database</code>) : Il d&eacute;finit l'ensemble du b&acirc;timent, quelles &eacute;tag&egrave;res il contient, et comment y acc&eacute;der.</p></li></ol></section><section class="chapter"><h3 id="explication-de-la-notion_1" data-toc="explication-de-la-notion_1">Explication de la notion</h3><p id="-lasy6n_96"><code class="code" id="-lasy6n_111">Room</code> s'articule autour de ces trois annotations majeures.</p><p id="-lasy6n_97"><span class="control" id="-lasy6n_112">1. <code class="code" id="-lasy6n_113">@Entity</code>: La Table de Donn&eacute;es</span></p><p id="-lasy6n_98">C'est une <code class="code" id="-lasy6n_114">data class</code> Kotlin qui repr&eacute;sente une table dans votre base de donn&eacute;es.</p><ul class="list _bullet" id="-lasy6n_99"><li class="list__item" id="-lasy6n_115"><p id="-lasy6n_118">L'annotation <code class="code" id="-lasy6n_119">@Entity</code> marque la classe comme une table. Vous pouvez sp&eacute;cifier le nom de la table (<code class="code" id="-lasy6n_120">tableName</code>).</p></li><li class="list__item" id="-lasy6n_116"><p id="-lasy6n_121">Chaque propri&eacute;t&eacute; de la <code class="code" id="-lasy6n_122">data class</code> repr&eacute;sente une colonne dans la table.</p></li><li class="list__item" id="-lasy6n_117"><p id="-lasy6n_123">L'une des propri&eacute;t&eacute;s doit &ecirc;tre la cl&eacute; primaire, annot&eacute;e avec <code class="code" id="-lasy6n_124">@PrimaryKey</code>. On peut la faire s'auto-incr&eacute;menter.</p></li></ul><div class="code-block" data-lang="kotlin">
// Représente une table &quot;notes&quot; dans la BDD
@Entity(tableName = &quot;notes&quot;)
data class Note(
    @PrimaryKey(autoGenerate = true)
    val id: Long = 0, // Clé primaire auto-générée

    val title: String, // Colonne &quot;title&quot; de type TEXT

    val content: String // Colonne &quot;content&quot; de type TEXT
)
</div><p id="-lasy6n_101"><span class="control" id="-lasy6n_125">2. <code class="code" id="-lasy6n_126">@Dao</code> (Data Access Object) : L'Interface des Op&eacute;rations</span></p><p id="-lasy6n_102">C'est une <span class="control" id="-lasy6n_127">interface</span> Kotlin qui d&eacute;finit comment vous acc&eacute;dez &agrave; vos donn&eacute;es. Vous y d&eacute;clarez des m&eacute;thodes, et <code class="code" id="-lasy6n_128">Room</code> se charge de g&eacute;n&eacute;rer le code d'impl&eacute;mentation.</p><ul class="list _bullet" id="-lasy6n_103"><li class="list__item" id="-lasy6n_129"><p id="-lasy6n_131">L'annotation <code class="code" id="-lasy6n_132">@Dao</code> marque l'interface.</p></li><li class="list__item" id="-lasy6n_130"><p id="-lasy6n_133">Vous utilisez des annotations pour chaque type d'op&eacute;ration :</p><ul class="list _bullet" id="-lasy6n_134"><li class="list__item" id="-lasy6n_135"><p id="-lasy6n_139"><code class="code" id="-lasy6n_140">@Insert</code>: Pour ins&eacute;rer un ou plusieurs objets.</p></li><li class="list__item" id="-lasy6n_136"><p id="-lasy6n_141"><code class="code" id="-lasy6n_142">@Update</code>: Pour mettre &agrave; jour un objet.</p></li><li class="list__item" id="-lasy6n_137"><p id="-lasy6n_143"><code class="code" id="-lasy6n_144">@Delete</code>: Pour supprimer un objet.</p></li><li class="list__item" id="-lasy6n_138"><p id="-lasy6n_145"><code class="code" id="-lasy6n_146">@Query</code>: Pour toute autre requ&ecirc;te (lecture, suppression complexe...). Vous &eacute;crivez la requ&ecirc;te SQL directement dans l'annotation.</p></li></ul></li></ul><div class="code-block" data-lang="kotlin">
@Dao
interface NoteDao {
    @Insert
    suspend fun insert(note: Note) // `suspend` pour les coroutines

    @Update
    suspend fun update(note: Note)

    @Delete
    suspend fun delete(note: Note)

    @Query(&quot;SELECT * FROM notes ORDER BY id DESC&quot;)
    fun getAllNotes(): List&lt;Note&gt; // Pas `suspend` si Room utilise un autre mécanisme

    @Query(&quot;SELECT * FROM notes WHERE id = :noteId&quot;)
    suspend fun getNoteById(noteId: Long): Note?
}
</div><aside class="prompt" data-type="warning" data-title="" id="-lasy6n_105"><p>Les op&eacute;rations d'&eacute;criture (`@Insert`, `@Update`, `@Delete`) et les requ&ecirc;tes potentiellement longues doivent &ecirc;tre ex&eacute;cut&eacute;es en dehors du thread principal. L'utilisation de `suspend` avec les coroutines est la mani&egrave;re moderne de le faire.</p></aside><p id="-lasy6n_106"><span class="control" id="-lasy6n_147">3. <code class="code" id="-lasy6n_148">@Database</code>: Le Point d'Entr&eacute;e de la Base de Donn&eacute;es</span></p><p id="-lasy6n_107">C'est une classe <span class="control" id="-lasy6n_149">abstraite</span> qui h&eacute;rite de <code class="code" id="-lasy6n_150">RoomDatabase</code>. Elle relie tous les &eacute;l&eacute;ments.</p><ul class="list _bullet" id="-lasy6n_108"><li class="list__item" id="-lasy6n_151"><p id="-lasy6n_154">L'annotation <code class="code" id="-lasy6n_156">@Database</code> prend en param&egrave;tres :</p><ul class="list _bullet" id="-lasy6n_155"><li class="list__item" id="-lasy6n_157"><p id="-lasy6n_159"><code class="code" id="-lasy6n_160">entities</code>: Un tableau de toutes vos classes <code class="code" id="-lasy6n_161">@Entity</code>.</p></li><li class="list__item" id="-lasy6n_158"><p id="-lasy6n_162"><code class="code" id="-lasy6n_163">version</code>: La version de votre sch&eacute;ma de base de donn&eacute;es. &Agrave; incr&eacute;menter &agrave; chaque modification du sch&eacute;ma.</p></li></ul></li><li class="list__item" id="-lasy6n_152"><p id="-lasy6n_164">La classe doit contenir une m&eacute;thode abstraite qui renvoie chaque <code class="code" id="-lasy6n_165">@Dao</code>.</p></li><li class="list__item" id="-lasy6n_153"><p id="-lasy6n_166">Elle contient g&eacute;n&eacute;ralement un <code class="code" id="-lasy6n_167">companion object</code> pour impl&eacute;menter le pattern <span class="control" id="-lasy6n_168">Singleton</span>, garantissant qu'une seule instance de la base de donn&eacute;es existe pour toute l'application.</p></li></ul><div class="code-block" data-lang="kotlin">
@Database(entities = [Note::class], version = 1)
abstract class AppDatabase : RoomDatabase() {

    abstract fun noteDao(): NoteDao

    companion object {
        // @Volatile garantit que la valeur est toujours à jour pour tous les threads
        @Volatile
        private var INSTANCE: AppDatabase? = null

        fun getDatabase(context: Context): AppDatabase {
            return INSTANCE ?: synchronized(this) {
                val instance = Room.databaseBuilder(
                    context.applicationContext,
                    AppDatabase::class.java,
                    &quot;app_database&quot; // Nom du fichier de la BDD
                ).build()
                INSTANCE = instance
                instance
            }
        }
    }
}
</div><style>.theme-dark .plantuml > svg {filter: hue-rotate(180deg) invert(0.9);}div.plantuml {overflow-x: auto;}</style><div class="plantuml"><?xml version="1.0" encoding="us-ascii" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="490px" preserveAspectRatio="none" style="width:622px;height:490px;background:#FFFFFF;" version="1.1" viewBox="0 0 622 490" width="622px" zoomAndPan="magnify"><defs/><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="156" x="226" y="23.5352">Architecture de Room</text><!--class AppDatabase--><g id="elem_AppDatabase"><rect codeLine="4" fill="#F1F1F1" height="89.5977" id="AppDatabase" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="272" x="154" y="44.4883"/><ellipse cx="240.25" cy="64.7988" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M243.2231,70.4419 Q242.6421,70.7407 242.0029,70.8901 Q241.3638,71.0396 240.6582,71.0396 Q238.1514,71.0396 236.8315,69.3877 Q235.5117,67.7358 235.5117,64.6147 Q235.5117,61.4854 236.8315,59.8335 Q238.1514,58.1816 240.6582,58.1816 Q241.3638,58.1816 242.0112,58.3311 Q242.6587,58.4805 243.2231,58.7793 L243.2231,61.502 Q242.5923,60.9209 241.9988,60.6511 Q241.4053,60.3813 240.7744,60.3813 Q239.4297,60.3813 238.7449,61.448 Q238.0601,62.5146 238.0601,64.6147 Q238.0601,66.7065 238.7449,67.7732 Q239.4297,68.8398 240.7744,68.8398 Q241.4053,68.8398 241.9988,68.5701 Q242.5923,68.3003 243.2231,67.7192 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="67" x="272.75" y="61.0898">&#171;Database&#187;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="91" x="260.75" y="77.1563">AppDatabase</text><line style="stroke:#181818;stroke-width:0.5;" x1="155" x2="425" y1="85.1094" y2="85.1094"/><line style="stroke:#181818;stroke-width:0.5;" x1="155" x2="425" y1="93.1094" y2="93.1094"/><ellipse cx="165" cy="106.8535" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="135" x="174" y="110.6445">noteDao(): NoteDao</text><ellipse cx="165" cy="123.3418" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="246" x="174" y="127.1328">getDatabase(context): AppDatabase</text></g><!--class NoteDao--><g id="elem_NoteDao"><rect codeLine="9" fill="#F1F1F1" height="89.5977" id="NoteDao" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="200" x="7" y="211.0883"/><ellipse cx="73.25" cy="231.3988" fill="#B4A7E5" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M69.1777,227.164 L69.1777,225.0058 L76.5571,225.0058 L76.5571,227.164 L74.0918,227.164 L74.0918,235.2406 L76.5571,235.2406 L76.5571,237.3988 L69.1777,237.3988 L69.1777,235.2406 L71.6431,235.2406 L71.6431,227.164 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="38" x="104.25" y="227.6898">&#171;DAO&#187;</text><text fill="#000000" font-family="sans-serif" font-size="14" font-style="italic" lengthAdjust="spacing" textLength="59" x="93.75" y="243.7562">NoteDao</text><line style="stroke:#181818;stroke-width:0.5;" x1="8" x2="206" y1="251.7094" y2="251.7094"/><line style="stroke:#181818;stroke-width:0.5;" x1="8" x2="206" y1="259.7094" y2="259.7094"/><ellipse cx="18" cy="273.4535" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="120" x="27" y="277.2445">insert(note: Note)</text><ellipse cx="18" cy="289.9418" fill="#84BE84" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="174" x="27" y="293.7328">getAllNotes(): List&lt;Note&gt;</text></g><!--class Note--><g id="elem_Note"><rect codeLine="14" fill="#F1F1F1" height="106.0859" id="Note" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="127" x="225.5" y="377.6783"/><ellipse cx="265.7" cy="397.9888" fill="#ADD1B2" rx="11" ry="11" style="stroke:#181818;stroke-width:1.0;"/><path d="M268.6731,403.6319 Q268.0921,403.9307 267.4529,404.0801 Q266.8138,404.2296 266.1082,404.2296 Q263.6014,404.2296 262.2815,402.5777 Q260.9617,400.9258 260.9617,397.8047 Q260.9617,394.6754 262.2815,393.0235 Q263.6014,391.3716 266.1082,391.3716 Q266.8138,391.3716 267.4612,391.5211 Q268.1087,391.6705 268.6731,391.9693 L268.6731,394.692 Q268.0423,394.1109 267.4488,393.8411 Q266.8553,393.5713 266.2244,393.5713 Q264.8797,393.5713 264.1949,394.638 Q263.5101,395.7046 263.5101,397.8047 Q263.5101,399.8965 264.1949,400.9632 Q264.8797,402.0298 266.2244,402.0298 Q266.8553,402.0298 267.4488,401.7601 Q268.0423,401.4903 268.6731,400.9092 Z " fill="#000000"/><text fill="#000000" font-family="sans-serif" font-size="12" font-style="italic" lengthAdjust="spacing" textLength="43" x="283.3" y="394.2798">&#171;Entity&#187;</text><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="32" x="288.8" y="410.3462">Note</text><line style="stroke:#181818;stroke-width:0.5;" x1="226.5" x2="351.5" y1="418.2994" y2="418.2994"/><ellipse cx="236.5" cy="432.0435" fill="none" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="55" x="245.5" y="435.8345">id: Long</text><ellipse cx="236.5" cy="448.5318" fill="none" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="75" x="245.5" y="452.3228">title: String</text><ellipse cx="236.5" cy="465.0201" fill="none" rx="3" ry="3" style="stroke:#038048;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="101" x="245.5" y="468.8111">content: String</text><line style="stroke:#181818;stroke-width:0.5;" x1="226.5" x2="351.5" y1="475.7642" y2="475.7642"/></g><g id="elem_GMN8"><path d="M461,68.9783 L461,85.2883 L426.11,89.2883 L461,93.2883 L461,109.5994 A0,0 0 0 0 461,109.5994 L615,109.5994 A0,0 0 0 0 615,109.5994 L615,78.9783 L605,68.9783 L461,68.9783 A0,0 0 0 0 461,68.9783 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M605,68.9783 L605,78.9783 L615,78.9783 L605,68.9783 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="59" x="467" y="86.5466">Singleton</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="133" x="467" y="101.8572">Point d'entr&#233;e unique</text></g><g id="elem_GMN11"><path d="M242,243.2283 L242,251.8883 L207.36,255.8883 L242,259.8883 L242,268.5388 A0,0 0 0 0 242,268.5388 L402,268.5388 A0,0 0 0 0 402,268.5388 L402,253.2283 L392,243.2283 L242,243.2283 A0,0 0 0 0 242,243.2283 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M392,243.2283 L392,253.2283 L402,253.2283 L392,243.2283 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="139" x="248" y="260.7966">Interface des requ&#234;tes</text></g><g id="elem_GMN14"><path d="M388,418.0683 L388,426.7283 L352.92,430.7283 L388,434.7283 L388,443.3788 A0,0 0 0 0 388,443.3788 L540,443.3788 A0,0 0 0 0 540,443.3788 L540,428.0683 L530,418.0683 L388,418.0683 A0,0 0 0 0 388,418.0683 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M530,418.0683 L530,428.0683 L540,428.0683 L530,418.0683 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="131" x="394" y="435.6366">Repr&#233;sente une table</text></g><!--link AppDatabase to NoteDao--><g id="link_AppDatabase_NoteDao"><path codeLine="20" d="M240.96,134.3983 C214.7,158.0083 186.9109,183.0057 160.6409,206.6357 " fill="none" id="AppDatabase-to-NoteDao" style="stroke:#181818;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/><polygon fill="#181818" points="156.18,210.6483,165.5463,207.6033,159.8974,207.3045,160.1962,201.6555,156.18,210.6483" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="45" x="204.99" y="177.6566">expose</text></g><!--link AppDatabase to Note--><g id="link_AppDatabase_Note"><path codeLine="21" d="M356.62,134.5183 C381.03,154.6783 405.88,180.8183 419,211.0883 C434.84,247.6183 434.31,263.9183 419,300.6783 C405.25,333.7083 383.0329,358.7205 357.3429,380.7705 " fill="none" id="AppDatabase-to-Note" style="stroke:#181818;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/><polygon fill="#181818" points="352.79,384.6783,362.2246,381.8518,356.5841,381.4218,357.0142,375.7813,352.79,384.6783" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="47" x="431.68" y="260.9566">conna&#238;t</text></g><!--link NoteDao to Note--><g id="link_NoteDao_Note"><path codeLine="22" d="M153.4,300.9483 C177.94,324.2483 203.868,348.8879 229.598,373.3079 " fill="none" id="NoteDao-to-Note" style="stroke:#181818;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/><polygon fill="#181818" points="233.95,377.4383,230.1756,368.3414,230.3233,373.9963,224.6684,374.144,233.95,377.4383" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="58" x="199" y="344.2466">manipule</text></g><!--SRC=[RP3FIiD04CRl-nHpCqNe0uGG2DI382hrwcLD9kt2TZRTdK15V20z-19vCMUQ9aRnDdz_tpV3ZZr25UkzOwovZmWDmZQ4Wp6rjob1rNKRo_R59eIYcCAoX3S3S4s1SMD3jihXVWorkaEU1hCw4EE9PM11Ck_6EAd7rjOuRIg-UfZ8ZX96pbHWPAykvCfxJPDgthd4XMQb4aV3cWhgXjZnwqnhP3ZGJcFMctDuukZ6mjaYyLmIrFBgzRgSBUQ0fox80VyDI5TGP8SlDjF2edUmvBhUep5w54ItspE4zjU7nOCuyCY1dkano8-WkH9lSVX0wCaTUnotFRRdvHzZj_C_6qmGyTWFd_AcFs8NBrli19c4h5W4aVVu3G00]--></g></svg></div></section><section class="chapter"><h3 id="exercice-1-mettre-en-place-room-pour-une-entit-user" data-toc="exercice-1-mettre-en-place-room-pour-une-entit-user">Exercice 1 : Mettre en place Room pour une entit&eacute; &quot;User&quot;</h3><p id="-lasy6n_169"><span class="control" id="-lasy6n_172">&Eacute;nonc&eacute; :</span> Mettez en place les trois piliers de Room pour g&eacute;rer une entit&eacute; <code class="code" id="-lasy6n_173">User</code>.</p><ol class="list _decimal" id="-lasy6n_170" type="1"><li class="list__item" id="-lasy6n_174"><p id="-lasy6n_177">Cr&eacute;ez une <code class="code" id="-lasy6n_178">data class</code> <code class="code" id="-lasy6n_179">User</code> annot&eacute;e comme une <code class="code" id="-lasy6n_180">@Entity</code>. Elle doit avoir un <code class="code" id="-lasy6n_181">id</code> (Long, cl&eacute; primaire auto-g&eacute;n&eacute;r&eacute;e), un <code class="code" id="-lasy6n_182">firstName</code> (String) et un <code class="code" id="-lasy6n_183">lastName</code> (String).</p></li><li class="list__item" id="-lasy6n_175"><p id="-lasy6n_184">Cr&eacute;ez une interface <code class="code" id="-lasy6n_185">UserDao</code> avec des m&eacute;thodes pour ins&eacute;rer un utilisateur et pour r&eacute;cup&eacute;rer tous les utilisateurs.</p></li><li class="list__item" id="-lasy6n_176"><p id="-lasy6n_186">Cr&eacute;ez la classe <code class="code" id="-lasy6n_187">AppDatabase</code> qui inclut l'entit&eacute; <code class="code" id="-lasy6n_188">User</code>.</p></li></ol><section class="chapter"><div class="collapse"><div class="collapse__title"><h4 id="correction-exercice-1" data-toc="correction-exercice-1"><span class="control" id="-lasy6n_199">Correction exercice 1</span></h4></div><div class="collapse__content"><p id="-lasy6n_190"><span class="control" id="-lasy6n_200">0. D&eacute;pendances (&agrave; ajouter dans <code class="code" id="-lasy6n_201">build.gradle.kts</code>)</span></p><div class="code-block" data-lang="kotlin">
dependencies {
    val room_version = &quot;2.6.1&quot;
    implementation(&quot;androidx.room:room-runtime:$room_version&quot;)
    // Annotation processor pour générer le code
    ksp(&quot;androidx.room:room-compiler:$room_version&quot;)
    // Support pour les coroutines Kotlin
    implementation(&quot;androidx.room:room-ktx:$room_version&quot;)
}
// N'oubliez pas d'appliquer le plugin KSP en haut du fichier
// plugins { id(&quot;com.google.devtools.ksp&quot;) }
</div><p id="-lasy6n_192"><span class="control" id="-lasy6n_202">1. <code class="code" id="-lasy6n_203">User.kt</code> (@Entity)</span></p><div class="code-block" data-lang="kotlin">
package fr.formation.room.models

import androidx.room.Entity
import androidx.room.PrimaryKey

@Entity(tableName = &quot;users&quot;)
data class User(
    @PrimaryKey(autoGenerate = true)
    val id: Long = 0,
    val firstName: String,
    val lastName: String
)
</div><p id="-lasy6n_194"><span class="control" id="-lasy6n_204">2. <code class="code" id="-lasy6n_205">UserDao.kt</code> (@Dao)</span></p><div class="code-block" data-lang="kotlin">
package fr.formation.room.dao

import androidx.room.Dao
import androidx.room.Insert
import androidx.room.Query
import fr.formation.room.models.User

@Dao
interface UserDao {
    @Insert
    suspend fun insert(user: User)

    @Query(&quot;SELECT * FROM users ORDER BY lastName ASC&quot;)
    fun getAllUsers(): List&lt;User&gt; // Pour cet exemple, on la laisse synchrone
}
</div><p id="-lasy6n_196"><span class="control" id="-lasy6n_206">3. <code class="code" id="-lasy6n_207">AppDatabase.kt</code> (@Database)</span></p><div class="code-block" data-lang="kotlin">
package fr.formation.room.database

import android.content.Context
import androidx.room.Database
import androidx.room.Room
import androidx.room.RoomDatabase
import fr.formation.room.dao.UserDao
import fr.formation.room.models.User

@Database(entities = [User::class], version = 1)
abstract class AppDatabase : RoomDatabase() {

    abstract fun userDao(): UserDao

    companion object {
        @Volatile
        private var INSTANCE: AppDatabase? = null

        fun getDatabase(context: Context): AppDatabase {
            return INSTANCE ?: synchronized(this) {
                val instance = Room.databaseBuilder(
                    context.applicationContext,
                    AppDatabase::class.java,
                    &quot;my_app_database&quot;
                )
                    .fallbackToDestructiveMigration() // Pour la simplicité du TP
                    .build()
                INSTANCE = instance
                instance
            }
        }
    }
}
</div></div></div></section></section></section><section class="chapter"><h2 id="tp-11-une-application-de-prise-de-notes-simple" data-toc="tp-11-une-application-de-prise-de-notes-simple">TP 11 : Une application de prise de notes simple</h2><p id="-lasy6n_208"><span class="control" id="-lasy6n_210">Objectif :</span> Cr&eacute;er une application qui permet d'ajouter des notes et de les afficher dans une liste. Les notes doivent persister m&ecirc;me apr&egrave;s la fermeture de l'application. (Pour ce TP, l'interaction avec la BDD se fera encore sur le thread principal pour la simplicit&eacute;, nous introduirons les coroutines au module suivant).</p><section class="procedure-steps" id="-lasy6n_209"><ol class="list _decimal" id="-lasy6n_211" type="1"><li class="list__item" id="-lasy6n_212"><p id="-lasy6n_217"><span class="control" id="-lasy6n_218">Mettez en place Room</span> avec l'entit&eacute; <code class="code" id="-lasy6n_219">Note</code> et le <code class="code" id="-lasy6n_220">NoteDao</code> vus dans l'exemple ci-dessus. N'oubliez pas les d&eacute;pendances.</p></li><li class="list__item" id="-lasy6n_213"><p id="-lasy6n_221"><span class="control" id="-lasy6n_223">Cr&eacute;ez un layout <code class="code" id="-lasy6n_224">activity_main.xml</code></span> qui contient :</p><ul class="list _bullet" id="-lasy6n_222"><li class="list__item" id="-lasy6n_225"><p id="-lasy6n_229">Un <code class="code" id="-lasy6n_230">EditText</code> pour le titre de la note.</p></li><li class="list__item" id="-lasy6n_226"><p id="-lasy6n_231">Un <code class="code" id="-lasy6n_232">EditText</code> pour le contenu de la note.</p></li><li class="list__item" id="-lasy6n_227"><p id="-lasy6n_233">Un <code class="code" id="-lasy6n_234">Button</code> &quot;Ajouter&quot;.</p></li><li class="list__item" id="-lasy6n_228"><p id="-lasy6n_235">Un <code class="code" id="-lasy6n_236">RecyclerView</code> pour afficher les notes.</p></li></ul></li><li class="list__item" id="-lasy6n_214"><p id="-lasy6n_237"><span class="control" id="-lasy6n_238">Cr&eacute;ez un <code class="code" id="-lasy6n_240">NoteAdapter</code></span> pour le <code class="code" id="-lasy6n_239">RecyclerView</code>.</p></li><li class="list__item" id="-lasy6n_215"><p id="-lasy6n_241"><span class="control" id="-lasy6n_243">Dans <code class="code" id="-lasy6n_244">MainActivity.kt</code>:</span></p><ul class="list _bullet" id="-lasy6n_242"><li class="list__item" id="-lasy6n_245"><p id="-lasy6n_249">Obtenez une instance de votre base de donn&eacute;es : <code class="code" id="-lasy6n_250">val db = AppDatabase.getDatabase(this)</code>.</p></li><li class="list__item" id="-lasy6n_246"><p id="-lasy6n_251">Cr&eacute;ez une fonction <code class="code" id="-lasy6n_253">loadNotes()</code> qui :</p><ul class="list _bullet" id="-lasy6n_252"><li class="list__item" id="-lasy6n_254"><p id="-lasy6n_257">R&eacute;cup&egrave;re toutes les notes via <code class="code" id="-lasy6n_258">db.noteDao().getAllNotes()</code>.</p></li><li class="list__item" id="-lasy6n_255"><p id="-lasy6n_259">Met &agrave; jour l'adapter du RecyclerView avec cette liste.</p></li><li class="list__item" id="-lasy6n_256"><p id="-lasy6n_260"><span class="control" id="-lasy6n_261">Attention :</span> par d&eacute;faut, Room interdit les requ&ecirc;tes sur le thread principal. Pour ce TP, lors de la construction de la base de donn&eacute;es, ajoutez <code class="code" id="-lasy6n_262">.allowMainThreadQueries()</code> juste avant <code class="code" id="-lasy6n_263">.build()</code>. C'est une <span class="control" id="-lasy6n_264">mauvaise pratique</span> pour une vraie application, mais cela nous permet de nous concentrer sur Room avant d'aborder l'asynchronisme.</p></li></ul></li><li class="list__item" id="-lasy6n_247"><p id="-lasy6n_265">Dans <code class="code" id="-lasy6n_266">onCreate</code>, appelez <code class="code" id="-lasy6n_267">loadNotes()</code>.</p></li><li class="list__item" id="-lasy6n_248"><p id="-lasy6n_268">Dans le <code class="code" id="-lasy6n_270">onClickListener</code> du bouton &quot;Ajouter&quot; :</p><ul class="list _bullet" id="-lasy6n_269"><li class="list__item" id="-lasy6n_271"><p id="-lasy6n_274">Cr&eacute;ez un nouvel objet <code class="code" id="-lasy6n_275">Note</code> &agrave; partir des <code class="code" id="-lasy6n_276">EditText</code>.</p></li><li class="list__item" id="-lasy6n_272"><p id="-lasy6n_277">Ins&eacute;rez-le dans la base de donn&eacute;es : <code class="code" id="-lasy6n_278">db.noteDao().insert(newNote)</code>.</p></li><li class="list__item" id="-lasy6n_273"><p id="-lasy6n_279">Appelez &agrave; nouveau <code class="code" id="-lasy6n_280">loadNotes()</code> pour rafra&icirc;chir la liste.</p></li></ul></li></ul></li><li class="list__item" id="-lasy6n_216"><p id="-lasy6n_281"><span class="control" id="-lasy6n_282">Testez :</span> Ajoutez quelques notes. Fermez compl&egrave;tement l'application. Relancez-la. Vos notes doivent toujours &ecirc;tre l&agrave; !</p></li></ol><ol class="list _decimal"></ol></section></section><section class="chapter"><div class="collapse"><div class="collapse__title"><h2 id="correction-du-tp-11" data-toc="correction-du-tp-11">Correction du TP 11</h2></div><div class="collapse__content"><section class="chapter"><h3 id="tape-1-mise-en-place-de-room" data-toc="tape-1-mise-en-place-de-room">&Eacute;tape 1 : Mise en place de Room</h3><p id="-lasy6n_288">C'est la partie la plus dense, car elle n&eacute;cessite la cr&eacute;ation de plusieurs classes et la configuration des d&eacute;pendances.</p><section class="chapter"><h4 id="1a-d-pendances" data-toc="1a-d-pendances">1a. D&eacute;pendances</h4><p id="-lasy6n_293">Ajoutez ceci &agrave; votre fichier <code class="code" id="-lasy6n_295">build.gradle.kts</code> (au niveau du module) et synchronisez.</p><div class="code-block" data-lang="kotlin">
plugins {
    // ...
    id(&quot;com.google.devtools.ksp&quot;) version &quot;1.9.22-1.0.17&quot;
}

android {
    // ...
}

dependencies {
    // ...
    // Room
    val room_version = &quot;2.6.1&quot;
    implementation(&quot;androidx.room:room-runtime:$room_version&quot;)
    ksp(&quot;androidx.room:room-compiler:$room_version&quot;)
    // Kotlin Extensions and Coroutines support for Room (bonne pratique pour plus tard)
    implementation(&quot;androidx.room:room-ktx:$room_version&quot;)
}
</div></section><section class="chapter"><h4 id="1b-entit-note" data-toc="1b-entit-note">1b. Entit&eacute; <code class="code" id="-lasy6n_299">Note</code></h4><p id="-lasy6n_297">Cr&eacute;ez un nouveau fichier <code class="code" id="-lasy6n_300">Note.kt</code>.</p><div class="code-block" data-lang="kotlin">
import androidx.room.Entity
import androidx.room.PrimaryKey

@Entity(tableName = &quot;note_table&quot;)
data class Note(
    @PrimaryKey(autoGenerate = true)
    val id: Int = 0, // 0 pour que Room génère l'ID
    val title: String,
    val content: String
)
</div></section><section class="chapter"><h4 id="1c-dao-notedao" data-toc="1c-dao-notedao">1c. DAO <code class="code" id="-lasy6n_304">NoteDao</code></h4><p id="-lasy6n_302">Cr&eacute;ez un nouveau fichier <code class="code" id="-lasy6n_305">NoteDao.kt</code>.</p><div class="code-block" data-lang="kotlin">
import androidx.room.Dao
import androidx.room.Insert
import androidx.room.Query

@Dao
interface NoteDao {
    // Récupère toutes les notes, ordonnées par ID descendant (les plus récentes en premier)
    @Query(&quot;SELECT * FROM note_table ORDER BY id DESC&quot;)
    fun getAllNotes(): List&lt;Note&gt;

    // Insère une nouvelle note
    @Insert
    fun insert(note: Note)
}
</div></section><section class="chapter"><h4 id="1d-base-de-donn-es-appdatabase" data-toc="1d-base-de-donn-es-appdatabase">1d. Base de donn&eacute;es <code class="code" id="-lasy6n_311">AppDatabase</code></h4><p id="-lasy6n_307">Cr&eacute;ez un nouveau fichier <code class="code" id="-lasy6n_312">AppDatabase.kt</code>.</p><div class="code-block" data-lang="kotlin">
import android.content.Context
import androidx.room.Database
import androidx.room.Room
import androidx.room.RoomDatabase

@Database(entities = [Note::class], version = 1, exportSchema = false)
abstract class AppDatabase : RoomDatabase() {

    abstract fun noteDao(): NoteDao

    companion object {
        @Volatile
        private var INSTANCE: AppDatabase? = null

        fun getDatabase(context: Context): AppDatabase {
            return INSTANCE ?: synchronized(this) {
                val instance = Room.databaseBuilder(
                    context.applicationContext,
                    AppDatabase::class.java,
                    &quot;note_database&quot;
                )
                // ATTENTION : Uniquement pour ce TP. Ne jamais utiliser en production.
                .allowMainThreadQueries() 
                .build()
                INSTANCE = instance
                instance
            }
        }
    }
}
</div><p id="-lasy6n_309"><span class="control" id="-lasy6n_313">Note importante :</span> La ligne <code class="code" id="-lasy6n_314">.allowMainThreadQueries()</code> est une &quot;triche&quot; pour simplifier l'exercice. Dans une vraie application, les op&eacute;rations de base de donn&eacute;es sont longues et doivent &ecirc;tre effectu&eacute;es sur un thread d'arri&egrave;re-plan (avec des Coroutines, par exemple) pour ne pas geler l'interface utilisateur.</p></section></section><section class="chapter"><h3 id="tape-2-le-layout-activity-main-xml" data-toc="tape-2-le-layout-activity-main-xml">&Eacute;tape 2 : Le Layout (<code class="code" id="-lasy6n_318">activity_main.xml</code>)</h3><div class="code-block" data-lang="markup">
&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
    xmlns:app=&quot;http://schemas.android.com/apk/res-auto&quot;
    xmlns:tools=&quot;http://schemas.android.com/tools&quot;
    android:layout_width=&quot;match_parent&quot;
    android:layout_height=&quot;match_parent&quot;
    android:orientation=&quot;vertical&quot;
    android:padding=&quot;16dp&quot;
    tools:context=&quot;.MainActivity&quot;&gt;

    &lt;EditText
        android:id=&quot;@+id/titleEditText&quot;
        android:layout_width=&quot;match_parent&quot;
        android:layout_height=&quot;wrap_content&quot;
        android:hint=&quot;Titre de la note&quot;
        android:inputType=&quot;textCapSentences&quot; /&gt;

    &lt;EditText
        android:id=&quot;@+id/contentEditText&quot;
        android:layout_width=&quot;match_parent&quot;
        android:layout_height=&quot;wrap_content&quot;
        android:layout_marginTop=&quot;8dp&quot;
        android:hint=&quot;Contenu...&quot;
        android:inputType=&quot;textMultiLine&quot; /&gt;

    &lt;Button
        android:id=&quot;@+id/addButton&quot;
        android:layout_width=&quot;wrap_content&quot;
        android:layout_height=&quot;wrap_content&quot;
        android:layout_gravity=&quot;end&quot;
        android:layout_marginTop=&quot;8dp&quot;
        android:text=&quot;Ajouter&quot; /&gt;

    &lt;androidx.recyclerview.widget.RecyclerView
        android:id=&quot;@+id/notesRecyclerView&quot;
        android:layout_width=&quot;match_parent&quot;
        android:layout_height=&quot;0dp&quot;
        android:layout_marginTop=&quot;16dp&quot;
        android:layout_weight=&quot;1&quot;
        tools:listitem=&quot;@layout/item_note&quot; /&gt;

&lt;/LinearLayout&gt;
</div></section><section class="chapter"><h3 id="tape-3-le-noteadapter-et-son-item-layout" data-toc="tape-3-le-noteadapter-et-son-item-layout">&Eacute;tape 3 : Le <code class="code" id="-lasy6n_322">NoteAdapter</code> et son Item Layout</h3><section class="chapter"><h4 id="item-note-xml" data-toc="item-note-xml"><code class="code" id="-lasy6n_326">item_note.xml</code></h4><p id="-lasy6n_324">Cr&eacute;ez ce fichier de layout pour repr&eacute;senter une seule note dans la liste.</p><div class="code-block" data-lang="markup">
&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
    android:layout_width=&quot;match_parent&quot;
    android:layout_height=&quot;wrap_content&quot;
    android:orientation=&quot;vertical&quot;
    android:padding=&quot;12dp&quot;
    android:layout_marginBottom=&quot;8dp&quot;
    android:background=&quot;@android:drawable/dialog_holo_light_frame&quot;&gt;

    &lt;TextView
        android:id=&quot;@+id/itemTitleTextView&quot;
        android:layout_width=&quot;match_parent&quot;
        android:layout_height=&quot;wrap_content&quot;
        android:textSize=&quot;18sp&quot;
        android:textStyle=&quot;bold&quot;
        android:text=&quot;Titre de la note&quot; /&gt;

    &lt;TextView
        android:id=&quot;@+id/itemContentTextView&quot;
        android:layout_width=&quot;match_parent&quot;
        android:layout_height=&quot;wrap_content&quot;
        android:layout_marginTop=&quot;4dp&quot;
        android:text=&quot;Contenu de la note...&quot; /&gt;
&lt;/LinearLayout&gt;
</div></section><section class="chapter"><h4 id="noteadapter-kt" data-toc="noteadapter-kt"><code class="code" id="-lasy6n_330">NoteAdapter.kt</code></h4><div class="code-block" data-lang="kotlin">
import android.view.LayoutInflater
import android.view.ViewGroup
import androidx.recyclerview.widget.RecyclerView
import com.example.yourapplication.databinding.ItemNoteBinding // Adaptez le package

class NoteAdapter(private var notes: List&lt;Note&gt;) : RecyclerView.Adapter&lt;NoteAdapter.NoteViewHolder&gt;() {

    inner class NoteViewHolder(val binding: ItemNoteBinding) : RecyclerView.ViewHolder(binding.root)

    override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): NoteViewHolder {
        val binding = ItemNoteBinding.inflate(LayoutInflater.from(parent.context), parent, false)
        return NoteViewHolder(binding)
    }

    override fun onBindViewHolder(holder: NoteViewHolder, position: Int) {
        val currentNote = notes[position]
        holder.binding.itemTitleTextView.text = currentNote.title
        holder.binding.itemContentTextView.text = currentNote.content
    }

    override fun getItemCount() = notes.size

    // Fonction pour mettre à jour la liste de notes et rafraîchir l'affichage
    fun updateNotes(newNotes: List&lt;Note&gt;) {
        notes = newNotes
        notifyDataSetChanged() // Rafraîchit tout le RecyclerView
    }
}
</div></section></section><section class="chapter"><h3 id="tape-4-l-activit-mainactivity-kt" data-toc="tape-4-l-activit-mainactivity-kt">&Eacute;tape 4 : L'Activit&eacute; (<code class="code" id="-lasy6n_334">MainActivity.kt</code>)</h3><p id="-lasy6n_332">C'est ici que l'on connecte tout : la base de donn&eacute;es, l'UI et l'adaptateur.</p><div class="code-block" data-lang="kotlin">
package com.example.yourapplication // Adaptez le package

import androidx.appcompat.app.AppCompatActivity
import android.os.Bundle
import androidx.recyclerview.widget.LinearLayoutManager
import com.example.yourapplication.databinding.ActivityMainBinding

class MainActivity : AppCompatActivity() {

    private lateinit var binding: ActivityMainBinding
    private lateinit var db: AppDatabase
    private lateinit var noteAdapter: NoteAdapter

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        binding = ActivityMainBinding.inflate(layoutInflater)
        setContentView(binding.root)

        // Obtenir une instance de la base de données
        db = AppDatabase.getDatabase(this)

        // Initialiser l'adapter avec une liste vide au départ
        noteAdapter = NoteAdapter(emptyList())

        // Configurer le RecyclerView
        binding.notesRecyclerView.adapter = noteAdapter
        binding.notesRecyclerView.layoutManager = LinearLayoutManager(this)

        // Charger les notes existantes au démarrage
        loadNotes()

        // Gérer le clic sur le bouton &quot;Ajouter&quot;
        binding.addButton.setOnClickListener {
            val title = binding.titleEditText.text.toString().trim()
            val content = binding.contentEditText.text.toString().trim()

            if (title.isNotEmpty() &amp;&amp; content.isNotEmpty()) {
                // Créer une nouvelle note
                val newNote = Note(title = title, content = content)
                
                // L'insérer dans la base de données
                db.noteDao().insert(newNote)

                // Rafraîchir la liste affichée
                loadNotes()

                // Vider les champs pour la prochaine saisie
                binding.titleEditText.text.clear()
                binding.contentEditText.text.clear()
            }
        }
    }

    /**
     * Récupère toutes les notes depuis la base de données et met à jour l'adapter.
     */
    private fun loadNotes() {
        val notes = db.noteDao().getAllNotes()
        noteAdapter.updateNotes(notes)
    }
}
</div></section><section class="chapter"><h3 id="tape-5-test" data-toc="tape-5-test">&Eacute;tape 5 : Test</h3><ol class="list _decimal" id="-lasy6n_335" type="1"><li class="list__item" id="-lasy6n_337"><p id="-lasy6n_343">Lancez l'application. L'&eacute;cran est vide.</p></li><li class="list__item" id="-lasy6n_338"><p id="-lasy6n_344">Entrez un titre et un contenu, puis cliquez sur &quot;Ajouter&quot;. La note appara&icirc;t dans la liste.</p></li><li class="list__item" id="-lasy6n_339"><p id="-lasy6n_345">Ajoutez une ou deux autres notes. Elles s'ajoutent en haut de la liste (gr&acirc;ce au <code class="code" id="-lasy6n_346">ORDER BY id DESC</code> dans le DAO).</p></li><li class="list__item" id="-lasy6n_340"><p id="-lasy6n_347">Maintenant, fermez l'application compl&egrave;tement (via le gestionnaire d'applications r&eacute;centes, faites un &quot;swipe&quot; pour la tuer).</p></li><li class="list__item" id="-lasy6n_341"><p id="-lasy6n_348">Relancez l'application.</p></li><li class="list__item" id="-lasy6n_342"><p id="-lasy6n_349"><span class="control" id="-lasy6n_350">R&eacute;sultat attendu :</span> Toutes vos notes sont toujours l&agrave;, charg&eacute;es depuis la base de donn&eacute;es Room. La persistance fonctionne</p></li></ol></section></div></div></section><section class="chapter"><h2 id="auto-valuation" data-toc="auto-valuation">Auto-&eacute;valuation</h2><p id="-lasy6n_351"><span class="control" id="-lasy6n_360">1. Quelle annotation est utilis&eacute;e pour marquer une <code class="code" id="-lasy6n_361">data class</code> comme une table de base de donn&eacute;es dans Room ? (QCM)</span></p><ul class="list _bullet" id="-lasy6n_352"><li class="list__item" id="-lasy6n_362"><p id="-lasy6n_366">A) <code class="code" id="-lasy6n_367">@Dao</code></p></li><li class="list__item" id="-lasy6n_363"><p id="-lasy6n_368">B) <code class="code" id="-lasy6n_369">@Table</code></p></li><li class="list__item" id="-lasy6n_364"><p id="-lasy6n_370">C) <code class="code" id="-lasy6n_371">@Entity</code></p></li><li class="list__item" id="-lasy6n_365"><p id="-lasy6n_372">D) <code class="code" id="-lasy6n_373">@Database</code></p></li></ul><p id="-lasy6n_353"><span class="control" id="-lasy6n_374">2. Quel est le r&ocirc;le principal d'une interface annot&eacute;e avec <code class="code" id="-lasy6n_375">@Dao</code>? (QCM)</span></p><ul class="list _bullet" id="-lasy6n_354"><li class="list__item" id="-lasy6n_376"><p id="-lasy6n_380">A) D&eacute;finir la structure de la base de donn&eacute;es, y compris la version.</p></li><li class="list__item" id="-lasy6n_377"><p id="-lasy6n_381">B) Servir de point d'entr&eacute;e unique (Singleton) pour acc&eacute;der &agrave; la base de donn&eacute;es.</p></li><li class="list__item" id="-lasy6n_378"><p id="-lasy6n_382">C) Repr&eacute;senter une ligne de donn&eacute;es dans une table.</p></li><li class="list__item" id="-lasy6n_379"><p id="-lasy6n_383">D) D&eacute;finir les m&eacute;thodes d'acc&egrave;s aux donn&eacute;es (requ&ecirc;tes SQL).</p></li></ul><p id="-lasy6n_355"><span class="control" id="-lasy6n_384">3. Que se passe-t-il si vous &eacute;crivez une requ&ecirc;te SQL avec une erreur de syntaxe dans une annotation <code class="code" id="-lasy6n_385">@Query</code>? (QCM)</span></p><ul class="list _bullet" id="-lasy6n_356"><li class="list__item" id="-lasy6n_386"><p id="-lasy6n_390">A) L'application plantera au moment o&ugrave; la requ&ecirc;te sera ex&eacute;cut&eacute;e.</p></li><li class="list__item" id="-lasy6n_387"><p id="-lasy6n_391">B) Le projet ne compilera pas, et Android Studio signalera une erreur.</p></li><li class="list__item" id="-lasy6n_388"><p id="-lasy6n_392">C) La requ&ecirc;te sera ignor&eacute;e silencieusement.</p></li><li class="list__item" id="-lasy6n_389"><p id="-lasy6n_393">D) Room essaiera de corriger l'erreur automatiquement.</p></li></ul><p id="-lasy6n_357"><span class="control" id="-lasy6n_394">4. Qu'est-ce que le pattern &quot;Singleton&quot; et pourquoi est-il important pour la classe <code class="code" id="-lasy6n_395">@Database</code>? (Question ouverte)</span></p><p id="-lasy6n_358"><span class="control" id="-lasy6n_396">5. Pourquoi Room interdit-il par d&eacute;faut l'ex&eacute;cution des requ&ecirc;tes sur le thread principal ? (Question ouverte)</span></p><section class="chapter"><div class="collapse"><div class="collapse__title"><h3 id="correction-de-l-auto-valuation" data-toc="correction-de-l-auto-valuation">Correction de l'auto-&eacute;valuation</h3></div><div class="collapse__content"><p id="-lasy6n_397"><span class="control" id="-lasy6n_408">1. Quelle annotation marque une <code class="code" id="-lasy6n_409">data class</code> comme une table ?</span></p><ul class="list _bullet" id="-lasy6n_398"><li class="list__item" id="-lasy6n_410"><p id="-lasy6n_412"><span class="control" id="-lasy6n_413">R&eacute;ponse : C) <code class="code" id="-lasy6n_414">@Entity</code></span></p></li><li class="list__item" id="-lasy6n_411"><p id="-lasy6n_415"><span class="control" id="-lasy6n_416">Justification :</span> L'annotation <code class="code" id="-lasy6n_417">@Entity</code> indique &agrave; Room que cette classe doit &ecirc;tre transform&eacute;e en une table dans la base de donn&eacute;es SQLite.</p></li></ul><p id="-lasy6n_399"><span class="control" id="-lasy6n_418">2. Quel est le r&ocirc;le principal d'une interface <code class="code" id="-lasy6n_419">@Dao</code>?</span></p><ul class="list _bullet" id="-lasy6n_400"><li class="list__item" id="-lasy6n_420"><p id="-lasy6n_422"><span class="control" id="-lasy6n_423">R&eacute;ponse : D) D&eacute;finir les m&eacute;thodes d'acc&egrave;s aux donn&eacute;es (requ&ecirc;tes SQL).</span></p></li><li class="list__item" id="-lasy6n_421"><p id="-lasy6n_424"><span class="control" id="-lasy6n_425">Justification :</span> Le DAO (Data Access Object) est le contrat qui d&eacute;finit toutes les op&eacute;rations possibles sur les donn&eacute;es, comme l'insertion, la s&eacute;lection, la mise &agrave; jour et la suppression.</p></li></ul><p id="-lasy6n_401"><span class="control" id="-lasy6n_426">3. Que se passe-t-il en cas d'erreur de syntaxe SQL ?</span></p><ul class="list _bullet" id="-lasy6n_402"><li class="list__item" id="-lasy6n_427"><p id="-lasy6n_429"><span class="control" id="-lasy6n_430">R&eacute;ponse : B) Le projet ne compilera pas, et Android Studio signalera une erreur.</span></p></li><li class="list__item" id="-lasy6n_428"><p id="-lasy6n_431"><span class="control" id="-lasy6n_432">Justification :</span> C'est l'un des plus grands avantages de Room. Il v&eacute;rifie la validit&eacute; de vos requ&ecirc;tes SQL au moment de la compilation, ce qui vous permet de corriger les erreurs avant m&ecirc;me de lancer l'application.</p></li></ul><p id="-lasy6n_403"><span class="control" id="-lasy6n_433">4. Qu'est-ce que le pattern &quot;Singleton&quot; et pourquoi est-il important pour la classe <code class="code" id="-lasy6n_434">@Database</code>?</span></p><ul class="list _bullet" id="-lasy6n_404"><li class="list__item" id="-lasy6n_435"><p id="-lasy6n_436"><span class="control" id="-lasy6n_437">R&eacute;ponse type :</span> Un Singleton est un design pattern qui garantit qu'il n'existe qu'une seule instance d'une classe pour toute l'application. C'est important pour la classe <code class="code" id="-lasy6n_438">@Database</code> car la cr&eacute;ation d'une connexion &agrave; une base de donn&eacute;es est une op&eacute;ration &quot;co&ucirc;teuse&quot; en termes de ressources. En utilisant un Singleton, on s'assure de ne cr&eacute;er cette connexion qu'une seule fois et de r&eacute;utiliser la m&ecirc;me instance partout, ce qui est beaucoup plus performant et &eacute;vite les conflits d'acc&egrave;s.</p></li></ul><p id="-lasy6n_405"><span class="control" id="-lasy6n_439">5. Pourquoi Room interdit-il les requ&ecirc;tes sur le thread principal ?</span></p><ul class="list _bullet" id="-lasy6n_406"><li class="list__item" id="-lasy6n_440"><p id="-lasy6n_441"><span class="control" id="-lasy6n_442">R&eacute;ponse type :</span> Les op&eacute;rations sur une base de donn&eacute;es impliquent des lectures/&eacute;critures sur le disque de l'appareil, ce qui peut &ecirc;tre lent (de quelques millisecondes &agrave; plusieurs secondes pour de grosses requ&ecirc;tes). Si une telle op&eacute;ration &eacute;tait effectu&eacute;e sur le thread principal (UI Thread), elle bloquerait toute l'interface utilisateur pendant sa dur&eacute;e, rendant l'application non r&eacute;active (&quot;freeze&quot;). L'utilisateur aurait une tr&egrave;s mauvaise exp&eacute;rience et le syst&egrave;me Android pourrait m&ecirc;me fermer l'application (erreur &quot;Application Not Responding&quot; - ANR). Room nous force donc &agrave; adopter de bonnes pratiques en ex&eacute;cutant ces t&acirc;ches longues sur un thread d'arri&egrave;re-plan.</p></li></ul></div></div></section></section><section class="chapter"><h2 id="conclusion-du-module" data-toc="conclusion-du-module">Conclusion du module</h2><p id="-lasy6n_443">Vous avez construit votre premi&egrave;re base de donn&eacute;es locale ! Vous savez maintenant comment mod&eacute;liser vos donn&eacute;es, d&eacute;finir des op&eacute;rations pour les manipuler et les structurer dans une base de donn&eacute;es robuste avec <code class="code" id="-lasy6n_445">Room</code>. C'est une comp&eacute;tence fondamentale pour toute application qui doit g&eacute;rer des donn&eacute;es structur&eacute;es.</p><p id="-lasy6n_444">Cependant, nous avons d&ucirc; &quot;tricher&quot; en autorisant les requ&ecirc;tes sur le thread principal. C'est une dette technique que nous devons maintenant rembourser. Comment ex&eacute;cuter ces op&eacute;rations de base de donn&eacute;es (et bient&ocirc;t, de r&eacute;seau) de mani&egrave;re asynchrone, sans jamais geler notre interface ? La r&eacute;ponse se trouve dans le prochain module, avec l'un des outils les plus puissants de Kotlin : les <span class="control" id="-lasy6n_446">Coroutines</span>.</p></section><div class="last-modified">01 novembre 2025</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="004-01-module-10.html" class="navigation-links__prev">Module 10 : Persistance des Donn&eacute;es Simples (`SharedPreferences`)</a><a href="004-03-module-12.html" class="navigation-links__next">Module 12 : Introduction aux Op&eacute;rations Asynchrones (Coroutines Kotlin)</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.js"></script></body></html>