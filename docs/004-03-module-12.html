<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2025-11-07T11:34:39.514969"><title>Module 12 : Introduction aux Op&eacute;rations Asynchrones (Coroutines Kotlin) | Android</title><script type="application/json" id="virtual-toc-data">[{"id":"objectifs-p-dagogiques","level":0,"title":"Objectifs pédagogiques","anchor":"#objectifs-p-dagogiques"},{"id":"introduction","level":0,"title":"Introduction","anchor":"#introduction"},{"id":"notions-abord-es","level":0,"title":"Notions abordées","anchor":"#notions-abord-es"},{"id":"le-probl-me-le-thread-principal-et-l-erreur-anr","level":0,"title":"Le Problème : Le Thread Principal et l\u0027erreur ANR","anchor":"#le-probl-me-le-thread-principal-et-l-erreur-anr"},{"id":"la-solution-les-coroutines-kotlin","level":0,"title":"La Solution : Les Coroutines Kotlin","anchor":"#la-solution-les-coroutines-kotlin"},{"id":"concepts-cl-s","level":0,"title":"Concepts Clés","anchor":"#concepts-cl-s"},{"id":"changer-de-contexte-avec-les-dispatchers","level":0,"title":"Changer de Contexte avec les Dispatchers","anchor":"#changer-de-contexte-avec-les-dispatchers"},{"id":"tp-12-simulateur-de-t-che-lente","level":0,"title":"TP 12 : Simulateur de Tâche Lente","anchor":"#tp-12-simulateur-de-t-che-lente"},{"id":"correction-du-tp-12","level":0,"title":"Correction du TP 12","anchor":"#correction-du-tp-12"},{"id":"auto-valuation","level":0,"title":"Auto-évaluation","anchor":"#auto-valuation"},{"id":"conclusion-du-module","level":0,"title":"Conclusion du module","anchor":"#conclusion-du-module"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.css" rel="stylesheet"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Module 12 : Introduction aux Op&eacute;rations Asynchrones (Coroutines Kotlin) | Android"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="Android Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/004-03-module-12.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Module 12 : Introduction aux Op&eacute;rations Asynchrones (Coroutines Kotlin) | Android"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/004-03-module-12.html#webpage",
    "url": "writerside-documentation/004-03-module-12.html",
    "name": "Module 12 : Introduction aux Op&eacute;rations Asynchrones (Coroutines Kotlin) | Android",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "Android Help"
}</script><!-- End Schema.org --></head><body data-id="004-03-module-12" data-main-title="Module 12 : Introduction aux Opérations Asynchrones (Coroutines Kotlin)" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="004-partie-04.md|Partie 4 : Gestion des Données"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>Android  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="004-03-module-12" id="004-03-module-12.md">Module 12 : Introduction aux Opérations Asynchrones (Coroutines Kotlin)</h1><section class="chapter"><h2 id="objectifs-p-dagogiques" data-toc="objectifs-p-dagogiques">Objectifs p&eacute;dagogiques</h2><p id="-tns6q9_14">&Agrave; la fin de ce module, vous serez capable de :</p><ul class="list _bullet" id="-tns6q9_15"><li class="list__item" id="-tns6q9_16"><p id="-tns6q9_21">Expliquer pourquoi les t&acirc;ches longues doivent &ecirc;tre ex&eacute;cut&eacute;es en dehors du thread principal.</p></li><li class="list__item" id="-tns6q9_17"><p id="-tns6q9_22">D&eacute;finir ce qu'est une coroutine et ses avantages par rapport aux threads traditionnels.</p></li><li class="list__item" id="-tns6q9_18"><p id="-tns6q9_23">Utiliser les concepts cl&eacute;s : <code class="code" id="-tns6q9_24">CoroutineScope</code>, <code class="code" id="-tns6q9_25">launch</code>, <code class="code" id="-tns6q9_26">suspend function</code>.</p></li><li class="list__item" id="-tns6q9_19"><p id="-tns6q9_27">Comprendre le r&ocirc;le des <code class="code" id="-tns6q9_28">Dispatchers</code> pour choisir sur quel thread ex&eacute;cuter une t&acirc;che.</p></li><li class="list__item" id="-tns6q9_20"><p id="-tns6q9_29">Appliquer les coroutines pour effectuer des op&eacute;rations de base de donn&eacute;es <code class="code" id="-tns6q9_30">Room</code> de mani&egrave;re asynchrone.</p></li></ul></section><section class="chapter"><h2 id="introduction" data-toc="introduction">Introduction</h2><p id="-tns6q9_31">Imaginez que vous &ecirc;tes un chef cuisinier dans un restaurant tr&egrave;s fr&eacute;quent&eacute;. Un client commande un plat qui n&eacute;cessite une cuisson lente de 30 minutes. Que faites-vous ? Est-ce que vous vous tenez debout devant le four, &agrave; ne rien faire d'autre pendant 30 minutes, en ignorant toutes les autres commandes ? Bien s&ucirc;r que non ! Ce serait l'&eacute;quivalent de bloquer le thread principal.</p><p id="-tns6q9_32">La bonne approche est de lancer la cuisson lente (une t&acirc;che de fond), puis de vous lib&eacute;rer imm&eacute;diatement pour pr&eacute;parer d'autres plats plus rapides. Vous gardez un &oelig;il sur votre cuisson, mais vous ne restez pas bloqu&eacute; &agrave; l'attendre. Les * <span class="emphasis" id="-tns6q9_33">coroutines</span>* sont votre super-pouvoir de chef multit&acirc;che. Elles vous permettent de lancer des op&eacute;rations longues (comme une requ&ecirc;te en base de donn&eacute;es ou un appel r&eacute;seau) et de continuer &agrave; travailler sur autre chose (comme garder l'interface utilisateur fluide) en attendant qu'elles se terminent. C'est la cl&eacute; pour des applications r&eacute;actives et sans &quot;freeze&quot;.</p></section><section class="chapter"><h2 id="notions-abord-es" data-toc="notions-abord-es">Notions abord&eacute;es</h2><ul class="list _bullet" id="-tns6q9_34"><li class="list__item" id="-tns6q9_36"><p id="-tns6q9_40">Le Probl&egrave;me : Le Thread Principal (UI Thread) et l'erreur ANR.</p></li><li class="list__item" id="-tns6q9_37"><p id="-tns6q9_41">La Solution : Les Coroutines Kotlin.</p></li><li class="list__item" id="-tns6q9_38"><p id="-tns6q9_42">Concepts Cl&eacute;s : <code class="code" id="-tns6q9_43">suspend function</code>, <code class="code" id="-tns6q9_44">CoroutineScope</code>, <code class="code" id="-tns6q9_45">launch</code>.</p></li><li class="list__item" id="-tns6q9_39"><p id="-tns6q9_46">Changer de Contexte avec les <code class="code" id="-tns6q9_47">Dispatchers</code>.</p></li></ul></section><section class="chapter"><h2 id="le-probl-me-le-thread-principal-et-l-erreur-anr" data-toc="le-probl-me-le-thread-principal-et-l-erreur-anr">Le Probl&egrave;me : Le Thread Principal et l'erreur ANR</h2><section class="chapter"><h3 id="introduction-la-notion" data-toc="introduction-la-notion">Introduction &agrave; la notion</h3><p id="-tns6q9_50">Le thread principal de votre application est comme le guichet unique d'une administration tr&egrave;s fr&eacute;quent&eacute;e. C'est le seul employ&eacute; qui peut interagir avec le public (mettre &agrave; jour l'UI). Si vous lui donnez une t&acirc;che qui prend 10 secondes ( comme aller chercher un dossier dans les archives), pendant ces 10 secondes, le guichet est ferm&eacute;, la file d'attente s' allonge, et les gens deviennent tr&egrave;s m&eacute;contents.</p></section><section class="chapter"><h3 id="explication-de-la-notion" data-toc="explication-de-la-notion">Explication de la notion</h3><p id="-tns6q9_51">Sur Android, toutes les interactions avec l'interface utilisateur (dessiner les vues, g&eacute;rer les clics, etc.) doivent se faire sur un seul et unique thread : le <span class="control" id="-tns6q9_57">thread principal</span> (ou UI Thread).</p><p id="-tns6q9_52">Si vous ex&eacute;cutez une op&eacute;ration longue (plus de quelques millisecondes) sur ce thread, vous le bloquez. L'application devient incapable de r&eacute;agir aux actions de l'utilisateur ou m&ecirc;me de se redessiner. Elle semble &quot;gel&eacute;e&quot;.</p><p id="-tns6q9_53">Si ce blocage dure plus de 5 secondes, le syst&egrave;me Android intervient et affiche la redoutable bo&icirc;te de dialogue <span class="control" id="-tns6q9_58">&quot; Application Not Responding&quot; (ANR)</span>, proposant &agrave; l'utilisateur de fermer l'application. C'est l'une des pires exp&eacute;riences utilisateur possibles.</p><p id="-tns6q9_54"><span class="control" id="-tns6q9_59">Op&eacute;rations qui ne doivent JAMAIS &ecirc;tre sur le thread principal :</span></p><ul class="list _bullet" id="-tns6q9_55"><li class="list__item" id="-tns6q9_60"><p id="-tns6q9_64">Les appels r&eacute;seau.</p></li><li class="list__item" id="-tns6q9_61"><p id="-tns6q9_65">Les lectures/&eacute;critures en base de donn&eacute;es.</p></li><li class="list__item" id="-tns6q9_62"><p id="-tns6q9_66">La lecture/&eacute;criture de gros fichiers sur le disque.</p></li><li class="list__item" id="-tns6q9_63"><p id="-tns6q9_67">Le traitement complexe d'images ou de donn&eacute;es.</p></li></ul></section></section><section class="chapter"><h2 id="la-solution-les-coroutines-kotlin" data-toc="la-solution-les-coroutines-kotlin">La Solution : Les Coroutines Kotlin</h2><section class="chapter"><h3 id="introduction-la-notion_1" data-toc="introduction-la-notion_1">Introduction &agrave; la notion</h3><p id="-tns6q9_70">Si les threads traditionnels sont des &quot;travailleurs&quot; lourds et co&ucirc;teux &agrave; embaucher, les coroutines sont des &quot;t&acirc;ches&quot; extr&ecirc;mement l&eacute;g&egrave;res. Vous pouvez en lancer des milliers sans ralentir votre syst&egrave;me. Elles ont la capacit&eacute; magique de se &quot;suspendre&quot; en attendant qu'une op&eacute;ration longue se termine, lib&eacute;rant ainsi le &quot;travailleur&quot; (le thread) pour qu'il puisse faire autre chose en attendant.</p></section><section class="chapter"><h3 id="explication-de-la-notion_1" data-toc="explication-de-la-notion_1">Explication de la notion</h3><p id="-tns6q9_71">Une coroutine est un bloc de code qui peut &ecirc;tre suspendu et repris plus tard. Elles permettent d'&eacute;crire du code asynchrone de mani&egrave;re <span class="control" id="-tns6q9_78">s&eacute;quentielle</span>, comme si c'&eacute;tait du code synchrone.</p><p id="-tns6q9_72"><span class="control" id="-tns6q9_79">Avant (avec des callbacks - &quot;l'enfer des callbacks&quot;) :</span></p><div class="code-block" data-lang="kotlin">
// Code difficile à lire et à maintenir
networkRequest(
    &quot;url&quot;,
    onSuccess = { data -&gt;
        databaseSave(
            data,
            onSuccess = {
                updateUi(&quot;Succès&quot;)
            },
            onError = { ... }
        )
    },
    onError = { ... }
)
</div><p id="-tns6q9_74"><span class="control" id="-tns6q9_80">Apr&egrave;s (avec des coroutines) :</span></p><div class="code-block" data-lang="kotlin">
// Code lisible, séquentiel et avec une gestion d'erreur simple
try {
    val data = networkRequest(&quot;url&quot;)
    databaseSave(data)
    updateUi(&quot;Succès&quot;)
} catch (e: Exception) {
    // Gérer l'erreur
}
</div><p id="-tns6q9_76">Les coroutines sont la solution recommand&eacute;e par Google pour la gestion de l'asynchronisme sur Android.</p></section></section><section class="chapter"><h2 id="concepts-cl-s" data-toc="concepts-cl-s">Concepts Cl&eacute;s</h2><section class="chapter"><h3 id="introduction-la-notion_2" data-toc="introduction-la-notion_2">Introduction &agrave; la notion</h3><p id="-tns6q9_83">Pour devenir un bon chef multit&acirc;che, vous devez ma&icirc;triser trois outils :</p><ol class="list _decimal" id="-tns6q9_84" type="1"><li class="list__item" id="-tns6q9_85"><p id="-tns6q9_88"><span class="control" id="-tns6q9_89">La recette &quot;sp&eacute;ciale cuisson lente&quot; (<code class="code" id="-tns6q9_90">suspend function</code>) :</span> Une recette qui signale qu'elle peut &ecirc;tre mise en pause.</p></li><li class="list__item" id="-tns6q9_86"><p id="-tns6q9_91"><span class="control" id="-tns6q9_92">La cuisine (<code class="code" id="-tns6q9_93">CoroutineScope</code>) :</span> L'environnement de travail o&ugrave; vous g&eacute;rez toutes vos cuissons en cours.</p></li><li class="list__item" id="-tns6q9_87"><p id="-tns6q9_94"><span class="control" id="-tns6q9_95">L'ordre &quot;Lancer la cuisson&quot; (<code class="code" id="-tns6q9_96">launch</code>) :</span> L'action de d&eacute;marrer une recette sans attendre &agrave; c&ocirc;t&eacute;.</p></li></ol></section><section class="chapter"><h3 id="explication-de-la-notion_2" data-toc="explication-de-la-notion_2">Explication de la notion</h3><p id="-tns6q9_97"><span class="control" id="-tns6q9_105">1. <code class="code" id="-tns6q9_110">suspend fun</code>: la fonction qui peut faire une pause</span> Une fonction marqu&eacute;e avec le mot-cl&eacute; <code class="code" id="-tns6q9_106">suspend</code> peut &ecirc;tre suspendue sans bloquer le thread. C'est une indication au compilateur : &quot;Attention, cette fonction peut prendre du temps&quot;. Une fonction <code class="code" id="-tns6q9_107">suspend</code> ne peut &ecirc;tre appel&eacute;e que depuis une autre fonction <code class="code" id="-tns6q9_108">suspend</code> ou depuis une coroutine. Room et Retrofit (que nous verrons plus tard) proposent des versions <code class="code" id="-tns6q9_109">suspend</code> de leurs fonctions.</p><div class="code-block" data-lang="kotlin">
// Room sait que cette opération doit être asynchrone
@Insert
suspend fun insert(note: Note)
</div><p id="-tns6q9_99"><span class="control" id="-tns6q9_111">2. <code class="code" id="-tns6q9_113">CoroutineScope</code>: le contexte de vie des coroutines</span> Une coroutine doit toujours &ecirc;tre lanc&eacute;e dans un <code class="code" id="-tns6q9_112">CoroutineScope</code>. Ce &quot;scope&quot; (port&eacute;e) d&eacute;finit le cycle de vie de la coroutine. Si le scope est annul&eacute;, toutes les coroutines lanc&eacute;es &agrave; l'int&eacute;rieur sont automatiquement annul&eacute;es. C'est crucial pour &eacute;viter les fuites de m&eacute;moire.</p><p id="-tns6q9_100">Android Jetpack fournit des scopes pr&eacute;d&eacute;finis et conscients du cycle de vie :</p><ul class="list _bullet" id="-tns6q9_101"><li class="list__item" id="-tns6q9_114"><p id="-tns6q9_116"><code class="code" id="-tns6q9_117">lifecycleScope</code> (dans une Activity ou un Fragment) : Li&eacute; au cycle de vie de l'Activity/Fragment. Annul&eacute; automatiquement quand le composant est d&eacute;truit.</p></li><li class="list__item" id="-tns6q9_115"><p id="-tns6q9_118"><code class="code" id="-tns6q9_119">viewModelScope</code> (dans un ViewModel) : Li&eacute; au cycle de vie du ViewModel. Annul&eacute; automatiquement quand le ViewModel est d&eacute;truit.</p></li></ul><p id="-tns6q9_102"><span class="control" id="-tns6q9_120">3. <code class="code" id="-tns6q9_121">launch</code>: lancer une coroutine &quot;fire-and-forget&quot;</span> C'est le constructeur de coroutine le plus courant. Il lance une nouvelle coroutine en arri&egrave;re-plan sans attendre son r&eacute;sultat. Parfait pour les op&eacute;rations d'&eacute;criture (insertion en BDD, mise &agrave; jour sur un serveur...).</p><div class="code-block" data-lang="kotlin">
// Dans une Activity ou un Fragment
lifecycleScope.launch {
    // Ce code s'exécute dans une coroutine
    db.noteDao().insert(newNote)
    // On ne peut pas appeler une fonction suspendue en dehors d'une coroutine
}
</div></section></section><section class="chapter"><h2 id="changer-de-contexte-avec-les-dispatchers" data-toc="changer-de-contexte-avec-les-dispatchers">Changer de Contexte avec les <code class="code" id="-tns6q9_127">Dispatchers</code></h2><section class="chapter"><h3 id="introduction-la-notion_3" data-toc="introduction-la-notion_3">Introduction &agrave; la notion</h3><p id="-tns6q9_128">Notre chef a plusieurs postes de travail dans sa cuisine : un pour la d&eacute;coupe (<code class="code" id="-tns6q9_129">Dispatchers.Main</code>), un pour la cuisson (<code class="code" id="-tns6q9_130">Dispatchers.IO</code>), et un pour les calculs complexes de recettes (<code class="code" id="-tns6q9_131">Dispatchers.Default</code>). Les <code class="code" id="-tns6q9_132">Dispatchers</code> permettent de dire &agrave; une t&acirc;che sur quel poste de travail elle doit s'ex&eacute;cuter.</p></section><section class="chapter"><h3 id="explication-de-la-notion_3" data-toc="explication-de-la-notion_3">Explication de la notion</h3><p id="-tns6q9_133">Un <code class="code" id="-tns6q9_138">Dispatcher</code> d&eacute;termine sur quel thread (ou pool de threads) la coroutine va s'ex&eacute;cuter.</p><ul class="list _bullet" id="-tns6q9_134"><li class="list__item" id="-tns6q9_139"><p id="-tns6q9_142"><code class="code" id="-tns6q9_143">Dispatchers.Main</code>: Le thread principal d'Android. <span class="control" id="-tns6q9_144">Uniquement</span> pour les op&eacute;rations d'UI.</p></li><li class="list__item" id="-tns6q9_140"><p id="-tns6q9_145"><code class="code" id="-tns6q9_146">Dispatchers.IO</code> (Input/Output) : Optimis&eacute; pour les op&eacute;rations de disque et de r&eacute;seau (base de donn&eacute;es, appels API, fichiers).</p></li><li class="list__item" id="-tns6q9_141"><p id="-tns6q9_147"><code class="code" id="-tns6q9_148">Dispatchers.Default</code>: Optimis&eacute; pour les t&acirc;ches gourmandes en CPU (trier une grande liste, parser un gros JSON...).</p></li></ul><p id="-tns6q9_135">On utilise <code class="code" id="-tns6q9_149">withContext(Dispatcher)</code> pour changer de contexte &agrave; l'int&eacute;rieur d'une coroutine.</p><style>.theme-dark .plantuml > svg {filter: hue-rotate(180deg) invert(0.9);}div.plantuml {overflow-x: auto;}</style><div class="plantuml"><?xml version="1.0" encoding="us-ascii" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="333px" preserveAspectRatio="none" style="width:848px;height:333px;background:#FFFFFF;" version="1.1" viewBox="0 0 848 333" width="848px" zoomAndPan="magnify"><defs/><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="303" x="273.75" y="28.5352">Flux d'une op&#233;ration BDD avec Coroutines</text><rect fill="#FFFFFF" height="175.1738" style="stroke:#181818;stroke-width:1.0;" width="10" x="276.5" y="105.2871"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="85" x2="85" y1="73.9766" y2="298.4609"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="281.5" x2="281.5" y1="73.9766" y2="298.4609"/><line style="stroke:#181818;stroke-width:0.5;stroke-dasharray:5.0,5.0;" x1="451" x2="451" y1="73.9766" y2="298.4609"/><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="161" x="5" y="42.4883"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="147" x="12" y="63.0234">Fragment (UI Thread)</text><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="161" x="5" y="297.4609"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="147" x="12" y="317.9961">Fragment (UI Thread)</text><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="124" x="219.5" y="42.4883"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="110" x="226.5" y="63.0234">CoroutineScope</text><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="124" x="219.5" y="297.4609"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="110" x="226.5" y="317.9961">CoroutineScope</text><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="145" x="379" y="42.4883"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="131" x="386" y="63.0234">Worker Thread (IO)</text><rect fill="#E2E2F0" height="30.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="145" x="379" y="297.4609"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="131" x="386" y="317.9961">Worker Thread (IO)</text><rect fill="#FFFFFF" height="175.1738" style="stroke:#181818;stroke-width:1.0;" width="10" x="276.5" y="105.2871"/><polygon fill="#181818" points="264.5,101.2871,274.5,105.2871,264.5,109.2871,268.5,105.2871" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="85.5" x2="270.5" y1="105.2871" y2="105.2871"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="92.5" y="100.5449">lifecycleScope.launch { ... }</text><polygon fill="#181818" points="439.5,148.9082,449.5,152.9082,439.5,156.9082,443.5,152.9082" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;" x1="286.5" x2="445.5" y1="152.9082" y2="152.9082"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="120" x="293.5" y="148.166">Lance la t&#226;che BDD</text><path d="M456,118.2871 L456,173.2871 L665,173.2871 L665,128.2871 L655,118.2871 L456,118.2871 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M655,118.2871 L655,128.2871 L665,128.2871 L655,118.2871 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="153" x="462" y="135.8555">Gr&#226;ce &#224; Room qui utilise</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="161" x="462" y="151.166">Dispatchers.IO par d&#233;faut</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="188" x="462" y="166.4766">pour les fonctions `suspend`</text><line style="stroke:#181818;stroke-width:1.0;" x1="451.5" x2="493.5" y1="204.6846" y2="204.6846"/><line style="stroke:#181818;stroke-width:1.0;" x1="493.5" x2="493.5" y1="204.6846" y2="217.6846"/><line style="stroke:#181818;stroke-width:1.0;" x1="452.5" x2="493.5" y1="217.6846" y2="217.6846"/><polygon fill="#181818" points="462.5,213.6846,452.5,217.6846,462.5,221.6846,458.5,217.6846" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="458.5" y="199.9424">db.noteDao().getAllNotes()</text><path d="M637,184.2188 L637,224.2188 L841,224.2188 L841,194.2188 L831,184.2188 L637,184.2188 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M831,184.2188 L831,194.2188 L841,194.2188 L831,184.2188 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="183" x="643" y="201.7871">Le thread UI n'est PAS bloqu&#233;</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="121" x="643" y="217.0977">et reste disponible.</text><polygon fill="#181818" points="297.5,247.1504,287.5,251.1504,297.5,255.1504,293.5,251.1504" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="291.5" x2="450.5" y1="251.1504" y2="251.1504"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="141" x="303.5" y="246.4082">La BDD renvoie la liste</text><polygon fill="#181818" points="96.5,276.4609,86.5,280.4609,96.5,284.4609,92.5,280.4609" style="stroke:#181818;stroke-width:1.0;"/><line style="stroke:#181818;stroke-width:1.0;stroke-dasharray:2.0,2.0;" x1="90.5" x2="280.5" y1="280.4609" y2="280.4609"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="167" x="102.5" y="275.7188">Le bloc 'launch' se termine</text><!--SRC=[LL7DJW8n4BxtARvm0Gxk0tWmKOc6X8Zn9ruuKBe3D9PsRQT4OtmNuutds1TpTXUCUvjEv_kPRzYo8zou_8voc3qXLFKXQhR1useoWTwJmNM88RFrb9IgT6HhRAKzOt0JzMP7KesUftZQHjBbU02Tq7pqH_yu7aseg1rgg_xKIuYl58zK64td7TrqtdMKQeXnTj5XSGvdrsG-ZEje2wUpDrjyeYWAV2bjsEurqr5ATIY1dmY5OQQz8JWDhd_CbfgjbG-2YNQpvNFSHkaJwcyyXB33MxQGFPnDjF0JcohDWegfcCuXgw2i3skTUU6ha2CS9Qo3DqsU2SkKKqM-N2hrPw1lfbmLZVP4Xz6us11VEdSdxpGQzppD2Dn197S_fCIultp4oeMtN1yMdXXHceHI30PlLuwA_vh_0fpfziwH_3xODWTPZUaKbKosaRUQmcymx38U8ea9YZivgIgfd_Gl]--></g></svg></div><aside class="prompt" data-type="tip" data-title="" id="-tns6q9_137"><p>Heureusement, les biblioth&egrave;ques modernes comme `Room` et `Retrofit` g&egrave;rent les `Dispatchers` pour vous ! Quand vous appelez une fonction `suspend` de Room, elle s'ex&eacute;cute automatiquement sur `Dispatchers.IO` sans que vous ayez besoin de le sp&eacute;cifier.</p></aside></section><section class="chapter"><h3 id="exercice-1-int-grer-les-coroutines-avec-room" data-toc="exercice-1-int-grer-les-coroutines-avec-room">Exercice 1 : Int&eacute;grer les coroutines avec Room</h3><p id="-tns6q9_150"><span class="control" id="-tns6q9_151">&Eacute;nonc&eacute; :</span> Reprenez le TP du module 11 (l'application de prise de notes). Supprimez l'appel &agrave; <code class="code" id="-tns6q9_152">.allowMainThreadQueries()</code> (la mauvaise pratique) et utilisez les coroutines pour effectuer les op&eacute;rations de base de donn&eacute;es en arri&egrave;re-plan.</p></section><section class="chapter"><div class="collapse"><div class="collapse__title"><h3 id="correction-exercice-1" data-toc="correction-exercice-1"><span class="control" id="-tns6q9_159">Correction exercice 1</span></h3></div><div class="collapse__content"><p id="-tns6q9_154"><span class="control" id="-tns6q9_160">1. Assurez-vous que vos m&eacute;thodes DAO sont <code class="code" id="-tns6q9_161">suspend</code> (pour l'&eacute;criture)</span></p><div class="code-block" data-lang="kotlin">
// Dans NoteDao.kt
@Dao
interface NoteDao {
    @Insert
    suspend fun insert(note: Note) // Doit être suspend

    @Query(&quot;SELECT * FROM notes&quot;)
    fun getAllNotes(): List&lt;Note&gt; // La lecture peut rester synchrone pour cet exemple
}
</div><p id="-tns6q9_156"><span class="control" id="-tns6q9_162">2. Modifiez <code class="code" id="-tns6q9_163">MainActivity.kt</code></span></p><div class="code-block" data-lang="kotlin">
// ... imports ...
import androidx.lifecycle.lifecycleScope
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.launch
import kotlinx.coroutines.withContext

class MainActivity : AppCompatActivity() {
    // ... binding et autres ...

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        // ...

        // IMPORTANT : retirez .allowMainThreadQueries() de votre AppDatabase.kt
        val db = AppDatabase.getDatabase(this)

        // On charge les données au démarrage
        loadNotes(db)

        binding.addButton.setOnClickListener {
            val title = binding.titleEditText.text.toString()
            val content = binding.contentEditText.text.toString()
            if (title.isNotEmpty()) {
                val newNote = Note(title = title, content = content)
                // On appelle la nouvelle fonction d'insertion
                insertNote(db, newNote)
            }
        }
    }

    // Fonction pour insérer une note en arrière-plan
    private fun insertNote(db: AppDatabase, note: Note) {
        // On lance une coroutine dans le scope du cycle de vie de l'activité
        lifecycleScope.launch {
            // Room exécute automatiquement insert() sur un thread IO
            db.noteDao().insert(note)

            // Après l'insertion, on rafraîchit la liste
            // en revenant sur le thread principal pour mettre à jour l'UI
            loadNotes(db)
        }
    }

    // Fonction pour charger les notes (qui implique aussi une lecture BDD)
    private fun loadNotes(db: AppDatabase) {
        lifecycleScope.launch {
            // On se déplace explicitement sur un thread IO pour la lecture BDD
            val notes = withContext(Dispatchers.IO) {
                db.noteDao().getAllNotes()
            }
            // On a maintenant la liste de notes
            // L'UI doit être mise à jour sur le thread Main
            // Pas besoin de withContext(Dispatchers.Main) ici car
            // le contexte du lifecycleScope est déjà le thread Main.
            updateRecyclerView(notes)
        }
    }

    private fun updateRecyclerView(notes: List&lt;Note&gt;) {
        // Mettez à jour votre adapter ici
        // (le code de l'adapter reste le même)
    }
}
</div></div></div></section></section><section class="chapter"><h2 id="tp-12-simulateur-de-t-che-lente" data-toc="tp-12-simulateur-de-t-che-lente">TP 12 : Simulateur de T&acirc;che Lente</h2><p id="-tns6q9_164"><span class="control" id="-tns6q9_166">Objectif :</span> Cr&eacute;er une application qui simule une t&acirc;che longue (comme un t&eacute;l&eacute;chargement) sans geler l'interface.</p><section class="procedure-steps" id="-tns6q9_165"><ol class="list _decimal" id="-tns6q9_167" type="1"><li class="list__item" id="-tns6q9_168"><p id="-tns6q9_172"><span class="control" id="-tns6q9_173">Cr&eacute;ez un layout</span> avec un <code class="code" id="-tns6q9_174">Button</code> (&quot;Lancer la t&acirc;che&quot;), un <code class="code" id="-tns6q9_175">ProgressBar</code> (initialement invisible) et un <code class="code" id="-tns6q9_176">TextView</code> (&quot;Pr&ecirc;t&quot;).</p></li><li class="list__item" id="-tns6q9_169"><p id="-tns6q9_177"><span class="control" id="-tns6q9_179">Dans <code class="code" id="-tns6q9_180">MainActivity.kt</code>:</span></p><ul class="list _bullet" id="-tns6q9_178"><li class="list__item" id="-tns6q9_181"><p id="-tns6q9_182">Dans le <code class="code" id="-tns6q9_183">onClickListener</code> du bouton, lancez une coroutine avec <code class="code" id="-tns6q9_184">lifecycleScope.launch</code>.</p></li></ul></li><li class="list__item" id="-tns6q9_170"><p id="-tns6q9_185"><span class="control" id="-tns6q9_187">&Agrave; l'int&eacute;rieur de la coroutine :</span></p><ul class="list _bullet" id="-tns6q9_186"><li class="list__item" id="-tns6q9_188"><p id="-tns6q9_192"><span class="control" id="-tns6q9_194">Avant la t&acirc;che longue :</span> Mettez &agrave; jour l'UI. Rendez le <code class="code" id="-tns6q9_195">ProgressBar</code> visible et changez le texte du <code class="code" id="-tns6q9_196">TextView</code> en &quot;T&eacute;l&eacute;chargement en cours...&quot;.</p><div class="code-block" data-lang="kotlin">
binding.progressBar.visibility = View.VISIBLE
binding.statusTextView.text = &quot;Téléchargement en cours...&quot;
</div></li><li class="list__item" id="-tns6q9_189"><p id="-tns6q9_197"><span class="control" id="-tns6q9_200">Simulez la t&acirc;che longue :</span> Cr&eacute;ez une fonction <code class="code" id="-tns6q9_201">suspend</code> qui simule le travail.</p><div class="code-block" data-lang="kotlin">
private suspend fun performLongTask(): String {
    // On se déplace sur un autre thread pour ne pas bloquer
    withContext(Dispatchers.Default) {
        delay(3000) // Attend 3 secondes
    }
    return &quot;Téléchargement terminé !&quot;
}
</div><p id="-tns6q9_199">(Vous devrez importer <code class="code" id="-tns6q9_202">kotlinx.coroutines.delay</code>).</p></li><li class="list__item" id="-tns6q9_190"><p id="-tns6q9_203">Appelez cette fonction <code class="code" id="-tns6q9_204">suspend</code> depuis votre coroutine <code class="code" id="-tns6q9_205">launch</code>.</p></li><li class="list__item" id="-tns6q9_191"><p id="-tns6q9_206"><span class="control" id="-tns6q9_207">Apr&egrave;s la t&acirc;che longue :</span> Mettez &agrave; jour l'UI &agrave; nouveau. Cachez le <code class="code" id="-tns6q9_208">ProgressBar</code> et affichez le message de r&eacute;sultat dans le <code class="code" id="-tns6q9_209">TextView</code>.</p></li></ul></li><li class="list__item" id="-tns6q9_171"><p id="-tns6q9_210"><span class="control" id="-tns6q9_211">Testez :</span> Lancez l'application. Cliquez sur le bouton. L'UI doit se mettre &agrave; jour imm&eacute;diatement, et pendant les 3 secondes d'attente, l'application doit rester parfaitement r&eacute;active (vous pouvez essayer de cliquer partout). Apr&egrave;s 3 secondes, l'UI se met &agrave; jour &agrave; nouveau avec le message final.</p></li></ol><ol class="list _decimal"></ol></section></section><section class="chapter"><div class="collapse"><div class="collapse__title"><h2 id="correction-du-tp-12" data-toc="correction-du-tp-12">Correction du TP 12</h2></div><div class="collapse__content"><section class="chapter"><h3 id="tape-1-mise-en-place-de-room" data-toc="tape-1-mise-en-place-de-room">&Eacute;tape 1 : Mise en place de Room</h3><p id="-tns6q9_217">C'est la partie la plus dense, car elle n&eacute;cessite la cr&eacute;ation de plusieurs classes et la configuration des d&eacute;pendances.</p><section class="chapter"><h4 id="1a-d-pendances" data-toc="1a-d-pendances">1a. D&eacute;pendances</h4><p id="-tns6q9_222">Ajoutez ceci &agrave; votre fichier <code class="code" id="-tns6q9_224">build.gradle.kts</code> (au niveau du module) et synchronisez.</p><div class="code-block" data-lang="kotlin">
plugins {
    // ...
    id(&quot;com.google.devtools.ksp&quot;) version &quot;1.9.22-1.0.17&quot;
}

android {
    // ...
}

dependencies {
    // ...
    // Room
    val room_version = &quot;2.6.1&quot;
    implementation(&quot;androidx.room:room-runtime:$room_version&quot;)
    ksp(&quot;androidx.room:room-compiler:$room_version&quot;)
    // Kotlin Extensions and Coroutines support for Room (bonne pratique pour plus tard)
    implementation(&quot;androidx.room:room-ktx:$room_version&quot;)
}
</div></section><section class="chapter"><h4 id="1b-entit-note" data-toc="1b-entit-note">1b. Entit&eacute; <code class="code" id="-tns6q9_228">Note</code></h4><p id="-tns6q9_226">Cr&eacute;ez un nouveau fichier <code class="code" id="-tns6q9_229">Note.kt</code>.</p><div class="code-block" data-lang="kotlin">
import androidx.room.Entity
import androidx.room.PrimaryKey

@Entity(tableName = &quot;note_table&quot;)
data class Note(
    @PrimaryKey(autoGenerate = true)
    val id: Int = 0, // 0 pour que Room génère l'ID
    val title: String,
    val content: String
)
</div></section><section class="chapter"><h4 id="1c-dao-notedao" data-toc="1c-dao-notedao">1c. DAO <code class="code" id="-tns6q9_233">NoteDao</code></h4><p id="-tns6q9_231">Cr&eacute;ez un nouveau fichier <code class="code" id="-tns6q9_234">NoteDao.kt</code>.</p><div class="code-block" data-lang="kotlin">
import androidx.room.Dao
import androidx.room.Insert
import androidx.room.Query

@Dao
interface NoteDao {
    // Récupère toutes les notes, ordonnées par ID descendant (les plus récentes en premier)
    @Query(&quot;SELECT * FROM note_table ORDER BY id DESC&quot;)
    fun getAllNotes(): List&lt;Note&gt;

    // Insère une nouvelle note
    @Insert
    fun insert(note: Note)
}
</div></section><section class="chapter"><h4 id="1d-base-de-donn-es-appdatabase" data-toc="1d-base-de-donn-es-appdatabase">1d. Base de donn&eacute;es <code class="code" id="-tns6q9_240">AppDatabase</code></h4><p id="-tns6q9_236">Cr&eacute;ez un nouveau fichier <code class="code" id="-tns6q9_241">AppDatabase.kt</code>.</p><div class="code-block" data-lang="kotlin">
import android.content.Context
import androidx.room.Database
import androidx.room.Room
import androidx.room.RoomDatabase

@Database(entities = [Note::class], version = 1, exportSchema = false)
abstract class AppDatabase : RoomDatabase() {

    abstract fun noteDao(): NoteDao

    companion object {
        @Volatile
        private var INSTANCE: AppDatabase? = null

        fun getDatabase(context: Context): AppDatabase {
            return INSTANCE ?: synchronized(this) {
                val instance = Room.databaseBuilder(
                    context.applicationContext,
                    AppDatabase::class.java,
                    &quot;note_database&quot;
                )
                // ATTENTION : Uniquement pour ce TP. Ne jamais utiliser en production.
                .allowMainThreadQueries() 
                .build()
                INSTANCE = instance
                instance
            }
        }
    }
}
</div><p id="-tns6q9_238"><span class="control" id="-tns6q9_242">Note importante :</span> La ligne <code class="code" id="-tns6q9_243">.allowMainThreadQueries()</code> est une &quot;triche&quot; pour simplifier l'exercice. Dans une vraie application, les op&eacute;rations de base de donn&eacute;es sont longues et doivent &ecirc;tre effectu&eacute;es sur un thread d'arri&egrave;re-plan (avec des Coroutines, par exemple) pour ne pas geler l'interface utilisateur.</p></section></section><section class="chapter"><h3 id="tape-2-le-layout-activity-main-xml" data-toc="tape-2-le-layout-activity-main-xml">&Eacute;tape 2 : Le Layout (<code class="code" id="-tns6q9_247">activity_main.xml</code>)</h3><div class="code-block" data-lang="markup">
&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
    xmlns:app=&quot;http://schemas.android.com/apk/res-auto&quot;
    xmlns:tools=&quot;http://schemas.android.com/tools&quot;
    android:layout_width=&quot;match_parent&quot;
    android:layout_height=&quot;match_parent&quot;
    android:orientation=&quot;vertical&quot;
    android:padding=&quot;16dp&quot;
    tools:context=&quot;.MainActivity&quot;&gt;

    &lt;EditText
        android:id=&quot;@+id/titleEditText&quot;
        android:layout_width=&quot;match_parent&quot;
        android:layout_height=&quot;wrap_content&quot;
        android:hint=&quot;Titre de la note&quot;
        android:inputType=&quot;textCapSentences&quot; /&gt;

    &lt;EditText
        android:id=&quot;@+id/contentEditText&quot;
        android:layout_width=&quot;match_parent&quot;
        android:layout_height=&quot;wrap_content&quot;
        android:layout_marginTop=&quot;8dp&quot;
        android:hint=&quot;Contenu...&quot;
        android:inputType=&quot;textMultiLine&quot; /&gt;

    &lt;Button
        android:id=&quot;@+id/addButton&quot;
        android:layout_width=&quot;wrap_content&quot;
        android:layout_height=&quot;wrap_content&quot;
        android:layout_gravity=&quot;end&quot;
        android:layout_marginTop=&quot;8dp&quot;
        android:text=&quot;Ajouter&quot; /&gt;

    &lt;androidx.recyclerview.widget.RecyclerView
        android:id=&quot;@+id/notesRecyclerView&quot;
        android:layout_width=&quot;match_parent&quot;
        android:layout_height=&quot;0dp&quot;
        android:layout_marginTop=&quot;16dp&quot;
        android:layout_weight=&quot;1&quot;
        tools:listitem=&quot;@layout/item_note&quot; /&gt;

&lt;/LinearLayout&gt;
</div></section><section class="chapter"><h3 id="tape-3-le-noteadapter-et-son-item-layout" data-toc="tape-3-le-noteadapter-et-son-item-layout">&Eacute;tape 3 : Le <code class="code" id="-tns6q9_251">NoteAdapter</code> et son Item Layout</h3><section class="chapter"><h4 id="item-note-xml" data-toc="item-note-xml"><code class="code" id="-tns6q9_255">item_note.xml</code></h4><p id="-tns6q9_253">Cr&eacute;ez ce fichier de layout pour repr&eacute;senter une seule note dans la liste.</p><div class="code-block" data-lang="markup">
&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;
&lt;LinearLayout xmlns:android=&quot;http://schemas.android.com/apk/res/android&quot;
    android:layout_width=&quot;match_parent&quot;
    android:layout_height=&quot;wrap_content&quot;
    android:orientation=&quot;vertical&quot;
    android:padding=&quot;12dp&quot;
    android:layout_marginBottom=&quot;8dp&quot;
    android:background=&quot;@android:drawable/dialog_holo_light_frame&quot;&gt;

    &lt;TextView
        android:id=&quot;@+id/itemTitleTextView&quot;
        android:layout_width=&quot;match_parent&quot;
        android:layout_height=&quot;wrap_content&quot;
        android:textSize=&quot;18sp&quot;
        android:textStyle=&quot;bold&quot;
        android:text=&quot;Titre de la note&quot; /&gt;

    &lt;TextView
        android:id=&quot;@+id/itemContentTextView&quot;
        android:layout_width=&quot;match_parent&quot;
        android:layout_height=&quot;wrap_content&quot;
        android:layout_marginTop=&quot;4dp&quot;
        android:text=&quot;Contenu de la note...&quot; /&gt;
&lt;/LinearLayout&gt;
</div></section><section class="chapter"><h4 id="noteadapter-kt" data-toc="noteadapter-kt"><code class="code" id="-tns6q9_259">NoteAdapter.kt</code></h4><div class="code-block" data-lang="kotlin">
import android.view.LayoutInflater
import android.view.ViewGroup
import androidx.recyclerview.widget.RecyclerView
import com.example.yourapplication.databinding.ItemNoteBinding // Adaptez le package

class NoteAdapter(private var notes: List&lt;Note&gt;) : RecyclerView.Adapter&lt;NoteAdapter.NoteViewHolder&gt;() {

    inner class NoteViewHolder(val binding: ItemNoteBinding) : RecyclerView.ViewHolder(binding.root)

    override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): NoteViewHolder {
        val binding = ItemNoteBinding.inflate(LayoutInflater.from(parent.context), parent, false)
        return NoteViewHolder(binding)
    }

    override fun onBindViewHolder(holder: NoteViewHolder, position: Int) {
        val currentNote = notes[position]
        holder.binding.itemTitleTextView.text = currentNote.title
        holder.binding.itemContentTextView.text = currentNote.content
    }

    override fun getItemCount() = notes.size

    // Fonction pour mettre à jour la liste de notes et rafraîchir l'affichage
    fun updateNotes(newNotes: List&lt;Note&gt;) {
        notes = newNotes
        notifyDataSetChanged() // Rafraîchit tout le RecyclerView
    }
}
</div></section></section><section class="chapter"><h3 id="tape-4-l-activit-mainactivity-kt" data-toc="tape-4-l-activit-mainactivity-kt">&Eacute;tape 4 : L'Activit&eacute; (<code class="code" id="-tns6q9_263">MainActivity.kt</code>)</h3><p id="-tns6q9_261">C'est ici que l'on connecte tout : la base de donn&eacute;es, l'UI et l'adaptateur.</p><div class="code-block" data-lang="kotlin">
package com.example.yourapplication // Adaptez le package

import androidx.appcompat.app.AppCompatActivity
import android.os.Bundle
import androidx.recyclerview.widget.LinearLayoutManager
import com.example.yourapplication.databinding.ActivityMainBinding

class MainActivity : AppCompatActivity() {

    private lateinit var binding: ActivityMainBinding
    private lateinit var db: AppDatabase
    private lateinit var noteAdapter: NoteAdapter

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        binding = ActivityMainBinding.inflate(layoutInflater)
        setContentView(binding.root)

        // Obtenir une instance de la base de données
        db = AppDatabase.getDatabase(this)

        // Initialiser l'adapter avec une liste vide au départ
        noteAdapter = NoteAdapter(emptyList())

        // Configurer le RecyclerView
        binding.notesRecyclerView.adapter = noteAdapter
        binding.notesRecyclerView.layoutManager = LinearLayoutManager(this)

        // Charger les notes existantes au démarrage
        loadNotes()

        // Gérer le clic sur le bouton &quot;Ajouter&quot;
        binding.addButton.setOnClickListener {
            val title = binding.titleEditText.text.toString().trim()
            val content = binding.contentEditText.text.toString().trim()

            if (title.isNotEmpty() &amp;&amp; content.isNotEmpty()) {
                // Créer une nouvelle note
                val newNote = Note(title = title, content = content)
                
                // L'insérer dans la base de données
                db.noteDao().insert(newNote)

                // Rafraîchir la liste affichée
                loadNotes()

                // Vider les champs pour la prochaine saisie
                binding.titleEditText.text.clear()
                binding.contentEditText.text.clear()
            }
        }
    }

    /**
     * Récupère toutes les notes depuis la base de données et met à jour l'adapter.
     */
    private fun loadNotes() {
        val notes = db.noteDao().getAllNotes()
        noteAdapter.updateNotes(notes)
    }
}
</div></section><section class="chapter"><h3 id="tape-5-test" data-toc="tape-5-test">&Eacute;tape 5 : Test</h3><ol class="list _decimal" id="-tns6q9_264" type="1"><li class="list__item" id="-tns6q9_266"><p id="-tns6q9_272">Lancez l'application. L'&eacute;cran est vide.</p></li><li class="list__item" id="-tns6q9_267"><p id="-tns6q9_273">Entrez un titre et un contenu, puis cliquez sur &quot;Ajouter&quot;. La note appara&icirc;t dans la liste.</p></li><li class="list__item" id="-tns6q9_268"><p id="-tns6q9_274">Ajoutez une ou deux autres notes. Elles s'ajoutent en haut de la liste (gr&acirc;ce au <code class="code" id="-tns6q9_275">ORDER BY id DESC</code> dans le DAO).</p></li><li class="list__item" id="-tns6q9_269"><p id="-tns6q9_276">Maintenant, fermez l'application compl&egrave;tement (via le gestionnaire d'applications r&eacute;centes, faites un &quot;swipe&quot; pour la tuer).</p></li><li class="list__item" id="-tns6q9_270"><p id="-tns6q9_277">Relancez l'application.</p></li><li class="list__item" id="-tns6q9_271"><p id="-tns6q9_278"><span class="control" id="-tns6q9_279">R&eacute;sultat attendu :</span> Toutes vos notes sont toujours l&agrave;, charg&eacute;es depuis la base de donn&eacute;es Room. La persistance fonctionne</p></li></ol></section></div></div></section><section class="chapter"><h2 id="auto-valuation" data-toc="auto-valuation">Auto-&eacute;valuation</h2><p id="-tns6q9_280"><span class="control" id="-tns6q9_289">1. Qu'est-ce qu'une erreur ANR (Application Not Responding) ? (QCM)</span></p><ul class="list _bullet" id="-tns6q9_281"><li class="list__item" id="-tns6q9_290"><p id="-tns6q9_294">A) Une erreur de compilation due &agrave; une syntaxe incorrecte.</p></li><li class="list__item" id="-tns6q9_291"><p id="-tns6q9_295">B) Une erreur qui se produit quand l'application n'a pas la permission d'acc&eacute;der &agrave; Internet.</p></li><li class="list__item" id="-tns6q9_292"><p id="-tns6q9_296">C) Une erreur affich&eacute;e par le syst&egrave;me quand le thread principal est bloqu&eacute; trop longtemps.</p></li><li class="list__item" id="-tns6q9_293"><p id="-tns6q9_297">D) Une erreur de logique dans la gestion des donn&eacute;es.</p></li></ul><p id="-tns6q9_282"><span class="control" id="-tns6q9_298">2. Quel est le r&ocirc;le du <code class="code" id="-tns6q9_299">Dispatcher.IO</code>? (QCM)</span></p><ul class="list _bullet" id="-tns6q9_283"><li class="list__item" id="-tns6q9_300"><p id="-tns6q9_304">A) Ex&eacute;cuter des t&acirc;ches sur le thread principal pour mettre &agrave; jour l'UI.</p></li><li class="list__item" id="-tns6q9_301"><p id="-tns6q9_305">B) Ex&eacute;cuter des t&acirc;ches optimis&eacute;es pour les op&eacute;rations de disque et de r&eacute;seau.</p></li><li class="list__item" id="-tns6q9_302"><p id="-tns6q9_306">C) Ex&eacute;cuter des t&acirc;ches qui n&eacute;cessitent beaucoup de calcul CPU.</p></li><li class="list__item" id="-tns6q9_303"><p id="-tns6q9_307">D) Annuler toutes les coroutines en cours.</p></li></ul><p id="-tns6q9_284"><span class="control" id="-tns6q9_308">3. Le mot-cl&eacute; <code class="code" id="-tns6q9_309">suspend</code> devant une fonction indique que... (QCM)</span></p><ul class="list _bullet" id="-tns6q9_285"><li class="list__item" id="-tns6q9_310"><p id="-tns6q9_314">A) La fonction est obsol&egrave;te et ne doit plus &ecirc;tre utilis&eacute;e.</p></li><li class="list__item" id="-tns6q9_311"><p id="-tns6q9_315">B) La fonction s'ex&eacute;cutera toujours tr&egrave;s rapidement.</p></li><li class="list__item" id="-tns6q9_312"><p id="-tns6q9_316">C) La fonction ne peut &ecirc;tre appel&eacute;e que depuis le thread principal.</p></li><li class="list__item" id="-tns6q9_313"><p id="-tns6q9_317">D) La fonction peut &ecirc;tre mise en pause et reprise, et doit &ecirc;tre appel&eacute;e depuis une coroutine.</p></li></ul><p id="-tns6q9_286"><span class="control" id="-tns6q9_318">4. Expliquez avec une analogie la diff&eacute;rence entre <code class="code" id="-tns6q9_319">launch</code> et <code class="code" id="-tns6q9_320">withContext</code>. (Question ouverte)</span></p><p id="-tns6q9_287"><span class="control" id="-tns6q9_321">5. Pourquoi le <code class="code" id="-tns6q9_322">lifecycleScope</code> est-il plus s&ucirc;r &agrave; utiliser dans un Fragment qu'un <code class="code" id="-tns6q9_323">GlobalScope</code>? (Question ouverte)</span></p><section class="chapter"><div class="collapse"><div class="collapse__title"><h3 id="correction-de-l-auto-valuation" data-toc="correction-de-l-auto-valuation">Correction de l'auto-&eacute;valuation</h3></div><div class="collapse__content"><p id="-tns6q9_324"><span class="control" id="-tns6q9_335">1. Qu'est-ce qu'une erreur ANR ?</span></p><ul class="list _bullet" id="-tns6q9_325"><li class="list__item" id="-tns6q9_336"><p id="-tns6q9_338"><span class="control" id="-tns6q9_339">R&eacute;ponse : C) Une erreur affich&eacute;e par le syst&egrave;me quand le thread principal est bloqu&eacute; trop longtemps.</span></p></li><li class="list__item" id="-tns6q9_337"><p id="-tns6q9_340"><span class="control" id="-tns6q9_341">Justification :</span> L'ANR est le m&eacute;canisme de d&eacute;fense d'Android contre les applications qui g&egrave;lent l'interface utilisateur, offrant &agrave; l'utilisateur un moyen de les fermer.</p></li></ul><p id="-tns6q9_326"><span class="control" id="-tns6q9_342">2. Quel est le r&ocirc;le du <code class="code" id="-tns6q9_343">Dispatcher.IO</code>?</span></p><ul class="list _bullet" id="-tns6q9_327"><li class="list__item" id="-tns6q9_344"><p id="-tns6q9_346"><span class="control" id="-tns6q9_347">R&eacute;ponse : B) Ex&eacute;cuter des t&acirc;ches optimis&eacute;es pour les op&eacute;rations de disque et de r&eacute;seau.</span></p></li><li class="list__item" id="-tns6q9_345"><p id="-tns6q9_348"><span class="control" id="-tns6q9_349">Justification :</span> Le <code class="code" id="-tns6q9_350">Dispatcher.IO</code> utilise un pool de threads sp&eacute;cialement con&ccedil;u pour g&eacute;rer les op&eacute;rations d'entr&eacute;e/sortie (Input/Output) qui sont souvent en &eacute;tat d'attente (attente du r&eacute;seau, attente du disque...).</p></li></ul><p id="-tns6q9_328"><span class="control" id="-tns6q9_351">3. Le mot-cl&eacute; <code class="code" id="-tns6q9_352">suspend</code> indique que...</span></p><ul class="list _bullet" id="-tns6q9_329"><li class="list__item" id="-tns6q9_353"><p id="-tns6q9_355"><span class="control" id="-tns6q9_356">R&eacute;ponse : D) La fonction peut &ecirc;tre mise en pause et reprise, et doit &ecirc;tre appel&eacute;e depuis une coroutine.</span></p></li><li class="list__item" id="-tns6q9_354"><p id="-tns6q9_357"><span class="control" id="-tns6q9_358">Justification :</span> C'est la d&eacute;finition m&ecirc;me d'une fonction de suspension. Elle signale sa nature asynchrone et s'int&egrave;gre dans le syst&egrave;me des coroutines.</p></li></ul><p id="-tns6q9_330"><span class="control" id="-tns6q9_359">4. Diff&eacute;rence entre <code class="code" id="-tns6q9_360">launch</code> et <code class="code" id="-tns6q9_361">withContext</code> (analogie).</span></p><ul class="list _bullet" id="-tns6q9_331"><li class="list__item" id="-tns6q9_362"><p id="-tns6q9_363"><span class="control" id="-tns6q9_365">R&eacute;ponse type (analogie de la cuisine) :</span></p><ul class="list _bullet" id="-tns6q9_364"><li class="list__item" id="-tns6q9_366"><p id="-tns6q9_368"><code class="code" id="-tns6q9_369">launch</code> c'est comme dire &agrave; un commis de cuisine : &quot;Va me pr&eacute;parer cette sauce&quot;. Vous lui donnez l'ordre et vous passez imm&eacute;diatement &agrave; autre chose. Vous ne vous souciez pas de quand il finit, vous savez juste que la t&acirc;che a &eacute;t&eacute; d&eacute;marr&eacute;e (&quot;fire-and-forget&quot;).</p></li><li class="list__item" id="-tns6q9_367"><p id="-tns6q9_370"><code class="code" id="-tns6q9_371">withContext</code> c'est comme dire : &quot;Pour cette &eacute;tape pr&eacute;cise, je dois aller au poste de p&acirc;tisserie&quot;. Vous vous d&eacute;placez vous-m&ecirc;me au bon poste de travail, vous faites la t&acirc;che, et vous ne continuez pas le reste de votre recette tant que cette &eacute;tape n'est pas finie. Cela change temporairement votre &quot;contexte&quot; de travail pour une t&acirc;che sp&eacute;cifique.</p></li></ul></li></ul><p id="-tns6q9_332"><span class="control" id="-tns6q9_372">5. Pourquoi <code class="code" id="-tns6q9_373">lifecycleScope</code> est-il plus s&ucirc;r que <code class="code" id="-tns6q9_374">GlobalScope</code>?</span></p><ul class="list _bullet" id="-tns6q9_333"><li class="list__item" id="-tns6q9_375"><p id="-tns6q9_376"><span class="control" id="-tns6q9_377">R&eacute;ponse type :</span> <code class="code" id="-tns6q9_378">lifecycleScope</code> est li&eacute; au cycle de vie du composant (Activity/Fragment). Si le Fragment est d&eacute;truit (par exemple, l'utilisateur quitte l'&eacute;cran), toutes les coroutines lanc&eacute;es dans son <code class="code" id="-tns6q9_379">lifecycleScope</code> sont * <span class="emphasis" id="-tns6q9_380">automatiquement annul&eacute;es</span>*. Cela emp&ecirc;che les coroutines de continuer &agrave; travailler inutilement en arri&egrave;re-plan et de potentiellement essayer de mettre &agrave; jour une UI qui n'existe plus (ce qui causerait un crash). <code class="code" id="-tns6q9_381">GlobalScope</code>, au contraire, est li&eacute; &agrave; la vie de toute l'application. Une coroutine lanc&eacute;e dans <code class="code" id="-tns6q9_382">GlobalScope</code> continuera de s'ex&eacute;cuter m&ecirc;me si le Fragment qui l'a lanc&eacute;e est d&eacute;truit, cr&eacute;ant ainsi des fuites de m&eacute;moire et des risques de crash.</p></li></ul></div></div></section></section><section class="chapter"><h2 id="conclusion-du-module" data-toc="conclusion-du-module">Conclusion du module</h2><p id="-tns6q9_383">Vous avez maintenant ajout&eacute; une comp&eacute;tence fondamentale &agrave; votre arc : la gestion de l'asynchronisme. Vous comprenez pourquoi il est vital de ne pas bloquer le thread principal et vous avez les outils pour ex&eacute;cuter des t&acirc;ches longues en arri&egrave;re-plan de mani&egrave;re propre et lisible avec les coroutines Kotlin.</p><p id="-tns6q9_384">Nous avons appliqu&eacute; ce savoir &agrave; notre base de donn&eacute;es locale. Il est temps de regarder vers l'ext&eacute;rieur. Dans le prochain module, nous allons utiliser nos nouvelles comp&eacute;tences en coroutines pour communiquer avec des serveurs distants, r&eacute;cup&eacute;rer des donn&eacute;es depuis des API REST avec la biblioth&egrave;que <code class="code" id="-tns6q9_385">Retrofit</code>, et ainsi rendre nos applications v&eacute;ritablement connect&eacute;es au monde.</p></section><div class="last-modified">01 novembre 2025</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="004-02-module-11.html" class="navigation-links__prev">Module 11 : G&eacute;rer une Base de Donn&eacute;es Locale avec `Room`</a><a href="004-04-module-13.html" class="navigation-links__next">Module 13 : Communiquer avec le Monde Ext&eacute;rieur (API REST &amp; `Retrofit`)</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.js"></script></body></html>