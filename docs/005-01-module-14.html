<!DOCTYPE html SYSTEM "about:legacy-compat">
<html lang="en-US" data-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex"><meta name="built-on" content="2025-11-07T11:34:39.515975"><title>Module 14 : Architecture d'Application : Le Pattern MVVM | Android</title><script type="application/json" id="virtual-toc-data">[{"id":"objectifs-p-dagogiques","level":0,"title":"Objectifs pédagogiques","anchor":"#objectifs-p-dagogiques"},{"id":"introduction","level":0,"title":"Introduction","anchor":"#introduction"},{"id":"notions-abord-es","level":0,"title":"Notions abordées","anchor":"#notions-abord-es"},{"id":"pourquoi-une-architecture","level":0,"title":"Pourquoi une Architecture ?","anchor":"#pourquoi-une-architecture"},{"id":"les-r-les-du-mvvm","level":0,"title":"Les Rôles du MVVM","anchor":"#les-r-les-du-mvvm"},{"id":"le-composant-viewmodel-d-android-jetpack","level":0,"title":"Le composant ViewModel d\u0027Android Jetpack","anchor":"#le-composant-viewmodel-d-android-jetpack"},{"id":"correction-exercice-1","level":0,"title":"Correction exercice 1","anchor":"#correction-exercice-1"},{"id":"tp-14-mettre-en-place-la-structure-mvvm-pour-notre-application-de-notes","level":0,"title":"TP 14 : Mettre en place la structure MVVM pour notre application de notes","anchor":"#tp-14-mettre-en-place-la-structure-mvvm-pour-notre-application-de-notes"},{"id":"correction-du-tp-14","level":0,"title":"Correction du TP 14","anchor":"#correction-du-tp-14"},{"id":"auto-valuation","level":0,"title":"Auto-évaluation","anchor":"#auto-valuation"},{"id":"conclusion-du-module","level":0,"title":"Conclusion du module","anchor":"#conclusion-du-module"}]</script><script type="application/json" id="topic-shortcuts"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.css" rel="stylesheet"><meta name="msapplication-TileColor" content="#000000"><link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"><meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Module 14 : Architecture d'Application : Le Pattern MVVM | Android"><meta property="og:description" content=""><meta property="og:image" content=""><meta property="og:site_name" content="Android Help"><meta property="og:type" content="website"><meta property="og:locale" content="en_US"><meta property="og:url" content="writerside-documentation/005-01-module-14.html"><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Module 14 : Architecture d'Application : Le Pattern MVVM | Android"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json">{
    "@context": "http://schema.org",
    "@type": "WebPage",
    "@id": "writerside-documentation/005-01-module-14.html#webpage",
    "url": "writerside-documentation/005-01-module-14.html",
    "name": "Module 14 : Architecture d'Application : Le Pattern MVVM | Android",
    "description": "",
    "image": "",
    "inLanguage":"en-US"
}</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json">{
    "@type": "WebSite",
    "@id": "writerside-documentation/#website",
    "url": "writerside-documentation/",
    "name": "Android Help"
}</script><!-- End Schema.org --></head><body data-id="005-01-module-14" data-main-title="Module 14 : Architecture d'Application : Le Pattern MVVM" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}" data-template="article" data-breadcrumbs="005-partie-05.md|Partie 5 : Architecture et Finalisation"><div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>Android  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="005-01-module-14" id="005-01-module-14.md">Module 14 : Architecture d'Application : Le Pattern MVVM</h1><section class="chapter"><h2 id="objectifs-p-dagogiques" data-toc="objectifs-p-dagogiques">Objectifs p&eacute;dagogiques</h2><p id="z9fyyr4_14">&Agrave; la fin de ce module, vous serez capable de :</p><ul class="list _bullet" id="z9fyyr4_15"><li class="list__item" id="z9fyyr4_16"><p id="z9fyyr4_20">Expliquer les probl&egrave;mes du code &quot;spaghetti&quot; et la n&eacute;cessit&eacute; d'une architecture.</p></li><li class="list__item" id="z9fyyr4_17"><p id="z9fyyr4_21">D&eacute;finir les responsabilit&eacute;s de chaque couche du pattern MVVM : View, ViewModel, et Model (Repository).</p></li><li class="list__item" id="z9fyyr4_18"><p id="z9fyyr4_22">Comprendre le principe de la s&eacute;paration des pr&eacute;occupations (Separation of Concerns).</p></li><li class="list__item" id="z9fyyr4_19"><p id="z9fyyr4_23">Mettre en place le composant <code class="code" id="z9fyyr4_24">ViewModel</code> d'Android Jetpack et comprendre son cycle de vie distinct.</p></li></ul></section><section class="chapter"><h2 id="introduction" data-toc="introduction">Introduction</h2><p id="z9fyyr4_25">Vous vous souvenez de notre compteur dans le module 4 ? Quand on tournait l'&eacute;cran, le compte revenait &agrave; z&eacute;ro. Pourquoi ? Parce que l'&eacute;tat (la variable <code class="code" id="z9fyyr4_27">counter</code>) &eacute;tait stock&eacute; dans l'Activity, et que l'Activity &eacute;tait d&eacute;truite et recr&eacute;&eacute;e. C'&eacute;tait un cauchemar &agrave; g&eacute;rer. De plus, si nous avions ajout&eacute; de la logique (sauvegarder le score, le comparer...), tout aurait &eacute;t&eacute; m&eacute;lang&eacute; dans le fichier de l'Activity, cr&eacute;ant un plat de &quot;spaghetti&quot; indigeste.</p><p id="z9fyyr4_26">L'architecture <span class="control" id="z9fyyr4_28">MVVM</span> est la recette qui nous sauve de ce chaos. C'est un mod&egrave;le qui s&eacute;pare notre code en trois couches distinctes, comme un g&acirc;teau &agrave; trois &eacute;tages. Chaque &eacute;tage a un r&ocirc;le pr&eacute;cis et ne communique qu'avec l'&eacute;tage directement adjacent. C'est cette s&eacute;paration stricte qui r&eacute;sout nos probl&egrave;mes de perte d'&eacute;tat et rend notre code propre, testable et maintenable.</p></section><section class="chapter"><h2 id="notions-abord-es" data-toc="notions-abord-es">Notions abord&eacute;es</h2><ul class="list _bullet" id="z9fyyr4_29"><li class="list__item" id="z9fyyr4_31"><p id="z9fyyr4_34">Pourquoi une Architecture ? Le probl&egrave;me du code &quot;spaghetti&quot;.</p></li><li class="list__item" id="z9fyyr4_32"><p id="z9fyyr4_35">Les R&ocirc;les du MVVM (Model-View-ViewModel).</p></li><li class="list__item" id="z9fyyr4_33"><p id="z9fyyr4_36">Le composant <code class="code" id="z9fyyr4_37">ViewModel</code> d'Android Jetpack.</p></li></ul></section><section class="chapter"><h2 id="pourquoi-une-architecture" data-toc="pourquoi-une-architecture">Pourquoi une Architecture ?</h2><section class="chapter"><h3 id="introduction-la-notion" data-toc="introduction-la-notion">Introduction &agrave; la notion</h3><p id="z9fyyr4_40">Avez-vous d&eacute;j&agrave; essay&eacute; de d&eacute;m&ecirc;ler un &eacute;norme n&oelig;ud d'&eacute;couteurs ? C'est frustrant, long, et on risque de tout casser. Le code sans architecture, c'est exactement &ccedil;a. Tout est emm&ecirc;l&eacute; : la logique de l'interface, la logique m&eacute;tier, l'acc&egrave;s aux donn&eacute;es... Une bonne architecture, c'est comme ranger chaque c&acirc;ble dans sa propre bo&icirc;te &eacute;tiquet&eacute;e.</p></section><section class="chapter"><h3 id="explication-de-la-notion" data-toc="explication-de-la-notion">Explication de la notion</h3><p id="z9fyyr4_41">Dans les premiers jours d'Android, il &eacute;tait courant de tout mettre dans l'Activity ou le Fragment : les clics sur les boutons, les appels r&eacute;seau, les requ&ecirc;tes en base de donn&eacute;es, la manipulation des donn&eacute;es... Ce qu'on appelle le <span class="control" id="z9fyyr4_45">code &quot;spaghetti&quot;</span> a des cons&eacute;quences d&eacute;sastreuses :</p><ul class="list _bullet" id="z9fyyr4_42"><li class="list__item" id="z9fyyr4_46"><p id="z9fyyr4_49"><span class="control" id="z9fyyr4_50">Difficile &agrave; lire et &agrave; maintenir :</span> Des fichiers de milliers de lignes o&ugrave; tout est m&eacute;lang&eacute;.</p></li><li class="list__item" id="z9fyyr4_47"><p id="z9fyyr4_51"><span class="control" id="z9fyyr4_52">Difficile &agrave; tester :</span> Comment tester une logique m&eacute;tier si elle est &eacute;troitement li&eacute;e &agrave; l'interface Android ?</p></li><li class="list__item" id="z9fyyr4_48"><p id="z9fyyr4_53"><span class="control" id="z9fyyr4_54">Sujet aux bugs :</span> La gestion du cycle de vie (comme la rotation d'&eacute;cran) devient un enfer, provoquant des fuites de m&eacute;moire et des pertes de donn&eacute;es.</p></li></ul><p id="z9fyyr4_43">Le principe fondamental pour r&eacute;soudre ce probl&egrave;me est la <span class="control" id="z9fyyr4_55">S&eacute;paration des Pr&eacute;occupations (Separation of Concerns)</span>. Chaque partie de votre application ne doit avoir qu'une seule et unique responsabilit&eacute;.</p></section></section><section class="chapter"><h2 id="les-r-les-du-mvvm" data-toc="les-r-les-du-mvvm">Les R&ocirc;les du MVVM</h2><section class="chapter"><h3 id="introduction-la-notion_1" data-toc="introduction-la-notion_1">Introduction &agrave; la notion</h3><p id="z9fyyr4_58">MVVM est un plan d'organisation qui d&eacute;finit trois r&ocirc;les clairs, comme dans une &eacute;quipe :</p><ul class="list _bullet" id="z9fyyr4_59"><li class="list__item" id="z9fyyr4_60"><p id="z9fyyr4_63">La <span class="control" id="z9fyyr4_64">View</span> est l' <span class="control" id="z9fyyr4_65">artiste</span>. Elle est dou&eacute;e pour dessiner l'interface et &eacute;couter le public (&eacute;v&eacute;nements utilisateur), mais elle est &quot;b&ecirc;te&quot; et ne prend aucune d&eacute;cision.</p></li><li class="list__item" id="z9fyyr4_61"><p id="z9fyyr4_66">Le <span class="control" id="z9fyyr4_67">ViewModel</span> est le <span class="control" id="z9fyyr4_68">manager</span>. Il ne sait pas dessiner, mais il prend les d&eacute;cisions logiques. Il dit &agrave; l'artiste quoi afficher et r&eacute;agit quand l'artiste lui rapporte une information du public. Il est le cerveau de l'interface.</p></li><li class="list__item" id="z9fyyr4_62"><p id="z9fyyr4_69">Le <span class="control" id="z9fyyr4_70">Model</span> est l' <span class="control" id="z9fyyr4_71">expert-comptable</span>. Il g&egrave;re les sources de donn&eacute;es (les livres de comptes, les contacts externes...). Le manager lui demande des informations, et il les lui fournit sans savoir &agrave; quoi elles serviront.</p></li></ul></section><section class="chapter"><h3 id="explication-de-la-notion_1" data-toc="explication-de-la-notion_1">Explication de la notion</h3><p id="z9fyyr4_72"><span class="control" id="z9fyyr4_81">Model (Mod&egrave;le)</span> C'est la couche de gestion des donn&eacute;es. Elle est responsable de fournir les donn&eacute;es, qu'elles viennent d'une base de donn&eacute;es <code class="code" id="z9fyyr4_82">Room</code>, d'une API <code class="code" id="z9fyyr4_83">Retrofit</code>, ou des <code class="code" id="z9fyyr4_84">SharedPreferences</code>.</p><ul class="list _bullet" id="z9fyyr4_73"><li class="list__item" id="z9fyyr4_85"><p id="z9fyyr4_88">Elle expose des donn&eacute;es brutes.</p></li><li class="list__item" id="z9fyyr4_86"><p id="z9fyyr4_89">Elle ne conna&icirc;t absolument rien de l'interface utilisateur.</p></li><li class="list__item" id="z9fyyr4_87"><p id="z9fyyr4_90">On y trouve souvent le <span class="control" id="z9fyyr4_91">Repository Pattern</span>: une classe (ex: <code class="code" id="z9fyyr4_92">UserRepository</code>) qui sert de source de v&eacute;rit&eacute; unique pour un certain type de donn&eacute;es, en cachant la complexit&eacute; (doit-on aller chercher les donn&eacute;es dans le cache ou sur le r&eacute;seau ?).</p></li></ul><p id="z9fyyr4_74"><span class="control" id="z9fyyr4_93">View (Vue)</span> C'est la couche UI, repr&eacute;sent&eacute;e par votre <code class="code" id="z9fyyr4_94">Fragment</code> ou votre <code class="code" id="z9fyyr4_95">Activity</code>.</p><ul class="list _bullet" id="z9fyyr4_75"><li class="list__item" id="z9fyyr4_96"><p id="z9fyyr4_99">Sa <span class="control" id="z9fyyr4_100">seule</span> responsabilit&eacute; est d'afficher les donn&eacute;es &agrave; l'&eacute;cran et de transmettre les actions de l'utilisateur au ViewModel.</p></li><li class="list__item" id="z9fyyr4_97"><p id="z9fyyr4_101">Elle ne contient <span class="control" id="z9fyyr4_102">AUCUNE</span> logique m&eacute;tier. Pas de calculs, pas de d&eacute;cisions.</p></li><li class="list__item" id="z9fyyr4_98"><p id="z9fyyr4_103">Elle observe les donn&eacute;es expos&eacute;es par le ViewModel et se met &agrave; jour en cons&eacute;quence.</p></li></ul><p id="z9fyyr4_76"><span class="control" id="z9fyyr4_104">ViewModel (Vue-Mod&egrave;le)</span> C'est le pont entre la View et le Model.</p><ul class="list _bullet" id="z9fyyr4_77"><li class="list__item" id="z9fyyr4_105"><p id="z9fyyr4_109">Il contient la logique de pr&eacute;sentation et l' <span class="control" id="z9fyyr4_110">&eacute;tat</span> de l'UI.</p></li><li class="list__item" id="z9fyyr4_106"><p id="z9fyyr4_111">Il r&eacute;cup&egrave;re les donn&eacute;es brutes du Model et les pr&eacute;pare pour que la View puisse les afficher facilement.</p></li><li class="list__item" id="z9fyyr4_107"><p id="z9fyyr4_112">Il expose des donn&eacute;es que la View peut &quot;observer&quot;.</p></li><li class="list__item" id="z9fyyr4_108"><p id="z9fyyr4_113">Il ne conna&icirc;t rien des d&eacute;tails de l'impl&eacute;mentation de la View (il ne sait pas s'il s'agit d'un Fragment, d'une Activity, etc.).</p></li></ul><style>.theme-dark .plantuml > svg {filter: hue-rotate(180deg) invert(0.9);}div.plantuml {overflow-x: auto;}</style><div class="plantuml"><?xml version="1.0" encoding="us-ascii" standalone="no"?><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" contentStyleType="text/css" height="541px" preserveAspectRatio="none" style="width:1010px;height:541px;background:#FFFFFF;" version="1.1" viewBox="0 0 1010 541" width="1010px" zoomAndPan="magnify"><defs/><g><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="254" x="371" y="23.5352">Diagramme de l'architecture MVVM</text><!--cluster View (Fragment/Activity)--><g id="cluster_View (Fragment/Activity)"><path d="M8.5,314.4683 L190.5,314.4683 A3.75,3.75 0 0 1 193,316.9683 L200,336.9566 L200.5,336.9566 A2.5,2.5 0 0 1 203,339.4566 L203,428.4583 A2.5,2.5 0 0 1 200.5,430.9583 L8.5,430.9583 A2.5,2.5 0 0 1 6,428.4583 L6,316.9683 A2.5,2.5 0 0 1 8.5,314.4683 " fill="none" style="stroke:#000000;stroke-width:1.5;"/><line style="stroke:#000000;stroke-width:1.5;" x1="6" x2="200" y1="336.9566" y2="336.9566"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="181" x="10" y="330.0034">View (Fragment/Activity)</text></g><!--cluster ViewModel Layer--><g id="cluster_ViewModel Layer"><path d="M729.5,314.4683 L852.5,314.4683 A3.75,3.75 0 0 1 855,316.9683 L862,336.9566 L1000.5,336.9566 A2.5,2.5 0 0 1 1003,339.4566 L1003,532.0783 A2.5,2.5 0 0 1 1000.5,534.5783 L729.5,534.5783 A2.5,2.5 0 0 1 727,532.0783 L727,316.9683 A2.5,2.5 0 0 1 729.5,314.4683 " fill="none" style="stroke:#000000;stroke-width:1.5;"/><line style="stroke:#000000;stroke-width:1.5;" x1="727" x2="862" y1="336.9566" y2="336.9566"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="122" x="731" y="330.0034">ViewModel Layer</text></g><!--cluster Model Layer--><g id="cluster_Model Layer"><path d="M398.5,43.4883 L486.5,43.4883 A3.75,3.75 0 0 1 489,45.9883 L496,65.9766 L700.5,65.9766 A2.5,2.5 0 0 1 703,68.4766 L703,417.8683 A2.5,2.5 0 0 1 700.5,420.3683 L398.5,420.3683 A2.5,2.5 0 0 1 396,417.8683 L396,45.9883 A2.5,2.5 0 0 1 398.5,43.4883 " fill="none" style="stroke:#000000;stroke-width:1.5;"/><line style="stroke:#000000;stroke-width:1.5;" x1="396" x2="496" y1="65.9766" y2="65.9766"/><text fill="#000000" font-family="sans-serif" font-size="14" font-weight="bold" lengthAdjust="spacing" textLength="87" x="400" y="59.0234">Model Layer</text></g><!--entity UI_Component--><g id="elem_UI_Component"><rect fill="#F1F1F1" height="46.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="54" x="77" y="368.4683"/><rect fill="#F1F1F1" height="10" style="stroke:#181818;stroke-width:0.5;" width="15" x="111" y="373.4683"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="109" y="375.4683"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="109" y="379.4683"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="14" x="92" y="402.0034">UI</text></g><!--entity VM--><g id="elem_VM"><rect fill="#F1F1F1" height="46.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="114" x="743" y="368.4683"/><rect fill="#F1F1F1" height="10" style="stroke:#181818;stroke-width:0.5;" width="15" x="837" y="373.4683"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="835" y="375.4683"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="835" y="379.4683"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="74" x="758" y="402.0034">ViewModel</text></g><g id="elem_GMN6"><path d="M743.5,477.9583 L743.5,518.5794 A0,0 0 0 0 743.5,518.5794 L986.5,518.5794 A0,0 0 0 0 986.5,518.5794 L986.5,487.9583 L976.5,477.9583 L856.89,477.9583 L814.1,415.3983 L848.89,477.9583 L743.5,477.9583 A0,0 0 0 0 743.5,477.9583 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M976.5,477.9583 L976.5,487.9583 L986.5,487.9583 L976.5,477.9583 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="222" x="749.5" y="495.5266">Contient la logique de pr&#233;sentation</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="94" x="749.5" y="510.8372">et l'&#233;tat de l'UI.</text></g><!--entity Repo--><g id="elem_Repo"><rect fill="#F1F1F1" height="46.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="113" x="548.5" y="204.9783"/><rect fill="#F1F1F1" height="10" style="stroke:#181818;stroke-width:0.5;" width="15" x="641.5" y="209.9783"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="639.5" y="211.9783"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="639.5" y="215.9783"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="73" x="563.5" y="238.5134">Repository</text></g><!--entity Room (DB)--><g id="elem_Room (DB)"><rect fill="#F1F1F1" height="46.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="112" x="412" y="97.4883"/><rect fill="#F1F1F1" height="10" style="stroke:#181818;stroke-width:0.5;" width="15" x="504" y="102.4883"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="502" y="104.4883"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="502" y="108.4883"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="72" x="427" y="131.0234">Room (DB)</text></g><!--entity Retrofit (API)--><g id="elem_Retrofit (API)"><rect fill="#F1F1F1" height="46.4883" rx="2.5" ry="2.5" style="stroke:#181818;stroke-width:0.5;" width="127" x="559.5" y="97.4883"/><rect fill="#F1F1F1" height="10" style="stroke:#181818;stroke-width:0.5;" width="15" x="666.5" y="102.4883"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="664.5" y="104.4883"/><rect fill="#F1F1F1" height="2" style="stroke:#181818;stroke-width:0.5;" width="4" x="664.5" y="108.4883"/><text fill="#000000" font-family="sans-serif" font-size="14" lengthAdjust="spacing" textLength="87" x="574.5" y="131.0234">Retrofit (API)</text></g><g id="elem_GMN15"><path d="M460,379.0583 L460,404.3688 L668,404.3688 L668,389.0583 L658,379.0583 L460,379.0583 " fill="#FEFFDD" style="stroke:#181818;stroke-width:0.5;"/><path d="M658,379.0583 L658,389.0583 L668,389.0583 L658,379.0583 " fill="#FEFFDD" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="187" x="466" y="396.6266">Source de v&#233;rit&#233; des donn&#233;es.</text></g><!--link Room (DB) to Repo--><g id="link_Room (DB)_Repo"><path d="M497.39,144.3683 C520.51,162.1683 552.56,186.8483 575.66,204.6283 " fill="none" id="Room (DB)-Repo" style="stroke:#181818;stroke-width:1.0;"/></g><!--link Retrofit (API) to Repo--><g id="link_Retrofit (API)_Repo"><path d="M619.14,144.3683 C616.1,162.1683 611.89,186.8483 608.86,204.6283 " fill="none" id="Retrofit (API)-Repo" style="stroke:#181818;stroke-width:1.0;"/></g><!--link Repo to GMN15--><g id="link_Repo_GMN15"><path d="M585.29,251.8883 C578.9,260.5683 572.55,270.9283 569,281.4683 C557.62,315.2983 560.26,358.3583 562.46,378.8483 " fill="none" id="Repo-GMN15" style="stroke:#181818;stroke-width:1.0;stroke-dasharray:7.0,7.0;"/></g><!--link UI_Component to VM--><g id="link_UI_Component_VM"><path d="M104.25,368.1683 C105.87,347.7083 111.83,319.1683 131.5,304.7583 C147.01,293.3983 601.87,268.1283 703,306.4683 C735.49,318.7883 760.3137,342.867 777.9037,363.557 " fill="none" id="UI_Component-to-VM" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="781.79,368.1283,779.008,358.6805,778.5514,364.3189,772.913,363.8623,781.79,368.1283" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="127" x="132.5" y="295.0366">L'utilisateur a cliqu&#233;</text></g><!--link VM to UI_Component--><g id="link_VM_UI_Component"><path d="M781.79,368.1383 C764.19,347.4583 735.48,318.8083 703,306.4683 C634.12,280.2983 304.53,295.0683 266,304.7583 C214.92,317.5983 167.3211,346.59 136.4211,368.01 " fill="none" id="VM-to-UI_Component" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="131.49,371.4283,141.1655,369.5883,135.5992,368.5797,136.6078,363.0135,131.49,371.4283" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="112" x="267" y="295.0366">via LiveData/Flow</text><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="111" x="651.9018" y="357.7837">Affiche cette liste</text></g><!--link VM to Repo--><g id="link_VM_Repo"><path d="M781.85,368.3483 C764.09,348.2683 735.09,319.9283 703,306.4683 C682.24,297.7583 617.28,315.0083 602,298.4683 C590.65,286.1883 590.9514,272.6223 595.0214,257.4923 " fill="none" id="VM-to-Repo" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="596.58,251.6983,590.3794,259.3503,595.2812,256.5266,598.1048,261.4284,596.58,251.6983" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="170" x="603" y="295.0366">Donne-moi les utilisateurs</text></g><!--link Repo to VM--><g id="link_Repo_VM"><path d="M661.99,231.7683 C700.17,236.5783 748.65,249.2083 778,281.4683 C799.48,305.0783 802.5647,337.6403 801.9347,362.0703 " fill="none" id="Repo-to-VM" style="stroke:#181818;stroke-width:1.0;"/><polygon fill="#181818" points="801.78,368.0683,806.0107,359.1744,801.9089,363.0699,798.0133,358.9682,801.78,368.0683" style="stroke:#181818;stroke-width:1.0;"/><text fill="#000000" font-family="sans-serif" font-size="13" lengthAdjust="spacing" textLength="153" x="789.17" y="295.0366">Retourne les utilisateurs</text></g><!--SRC=[PL11QXj14BpFAvgzI89iVDV1e5WO11AO1EdYcD0PjUGcizFoJA-CC7xGlcC_bjw9abZsRRgwQggwb3KGp1dt2Pk6O4iGHfZy8ojvRHF1QhDPENT0_mlt1DM6wHd6jmdt3KMzcddb8-jfKi6B0xXVBnu0CwmNFswaEKWqZdjz9r_9bW8iyKJfhFg75h7v0KHHWf-YAWt8ph0ft4XKjWyX80JPyrDRyXvItsM3KLdYzqYs7_MTZN-EMIy-NoJuwFwL3f9P9PsA_J0MMCnwFFyoUO2w_e-I9jcnmdXsjxXOlKiye5Fu9cto9UQnxn9htzaxmrPYx3lA9Th8kA6aps1tMEV1A5vQ_qZvaq7GAWVEE9nk6moCsRsj6EfhQmYcK2r7PwvIcm311wkfxofdQoDTY8m-s-tONC2JMdZJALKmFZB2aeyqHyMhso3F4tVM3qSDkhdbfxeHBe7UMERA5KxzDv7rPHL4-a1qplq6]--></g></svg></div><figure id="z9fyyr4_79"><img alt="MVM.svg" src="images/MVM.svg" title="MVM.svg" width="2006" height="1082"></figure></section></section><section class="chapter"><h2 id="le-composant-viewmodel-d-android-jetpack" data-toc="le-composant-viewmodel-d-android-jetpack">Le composant <code class="code" id="z9fyyr4_119">ViewModel</code> d'Android Jetpack</h2><section class="chapter"><h3 id="introduction-la-notion_2" data-toc="introduction-la-notion_2">Introduction &agrave; la notion</h3><p id="z9fyyr4_120">Le composant <code class="code" id="z9fyyr4_121">ViewModel</code> de Google est la cl&eacute; de vo&ucirc;te de cette architecture. C'est un manager tr&egrave;s sp&eacute;cial : il a son propre bureau, ind&eacute;pendant de la sc&egrave;ne. Quand la sc&egrave;ne est d&eacute;truite et reconstruite (rotation d'&eacute;cran), le manager reste tranquillement dans son bureau, avec tous ses dossiers intacts. Quand la nouvelle sc&egrave;ne est pr&ecirc;te, elle vient simplement se reconnecter au m&ecirc;me manager.</p></section><section class="chapter"><h3 id="explication-de-la-notion_2" data-toc="explication-de-la-notion_2">Explication de la notion</h3><p id="z9fyyr4_122">Un <code class="code" id="z9fyyr4_125">ViewModel</code> est une classe qui h&eacute;rite de <code class="code" id="z9fyyr4_126">androidx.lifecycle.ViewModel</code>. Sa caract&eacute;ristique magique est qu'il est * <span class="emphasis" id="z9fyyr4_127">conscient du cycle de vie, mais d'une mani&egrave;re diff&eacute;rente</span>* :</p><ul class="list _bullet" id="z9fyyr4_123"><li class="list__item" id="z9fyyr4_128"><p id="z9fyyr4_131">Un <code class="code" id="z9fyyr4_132">ViewModel</code> est cr&eacute;&eacute; la premi&egrave;re fois qu'un <code class="code" id="z9fyyr4_133">Fragment</code> ou une <code class="code" id="z9fyyr4_134">Activity</code> le demande.</p></li><li class="list__item" id="z9fyyr4_129"><p id="z9fyyr4_135">Il <span class="control" id="z9fyyr4_136">survit</span> aux changements de configuration (comme la rotation) qui d&eacute;truisent et recr&eacute;ent l'Activity/Fragment.</p></li><li class="list__item" id="z9fyyr4_130"><p id="z9fyyr4_137">Il n'est d&eacute;truit que lorsque le composant UI qui lui est associ&eacute; est d&eacute;finitivement d&eacute;truit (ex: l'utilisateur quitte l'&eacute;cran avec le bouton Retour).</p></li></ul><p id="z9fyyr4_124">Ceci <span class="control" id="z9fyyr4_138">r&eacute;sout compl&egrave;tement</span> le probl&egrave;me de la perte d'&eacute;tat. L'&eacute;tat de l'UI est stock&eacute; dans le <code class="code" id="z9fyyr4_139">ViewModel</code>, pas dans la View.</p></section><section class="chapter"><h3 id="mise-en-place" data-toc="mise-en-place">Mise en place</h3><p id="z9fyyr4_140"><span class="control" id="z9fyyr4_147">1. Ajouter la d&eacute;pendance</span> dans <code class="code" id="z9fyyr4_148">build.gradle.kts</code></p><div class="code-block" data-lang="kotlin">
dependencies {
    // ViewModel
    implementation(&quot;androidx.lifecycle:lifecycle-viewmodel-ktx:2.7.0&quot;)
    // Pour l'instanciation dans les fragments
    implementation(&quot;androidx.fragment:fragment-ktx:1.6.2&quot;)
}
</div><p id="z9fyyr4_142"><span class="control" id="z9fyyr4_149">2. Cr&eacute;er la classe ViewModel</span></p><div class="code-block" data-lang="kotlin">
package fr.formation.mvvm.counter

import androidx.lifecycle.ViewModel

// Notre ViewModel pour le compteur
class CounterViewModel : ViewModel() {

    // L'état (le compteur) est maintenant ici, à l'abri des rotations
    var count = 0
        private set // On ne peut le modifier que depuis le ViewModel

    fun increment() {
        count++
    }
}
</div><p id="z9fyyr4_144"><span class="control" id="z9fyyr4_150">3. Instancier le ViewModel dans la View (Fragment/Activity)</span> On utilise le d&eacute;l&eacute;gu&eacute; de propri&eacute;t&eacute; <code class="code" id="z9fyyr4_151">by viewModels()</code> qui vient de la d&eacute;pendance <code class="code" id="z9fyyr4_152">fragment-ktx</code>.</p><div class="code-block" data-lang="kotlin">
package fr.formation.mvvm.counter

import androidx.appcompat.app.AppCompatActivity
import android.os.Bundle
import androidx.activity.viewModels // Import important

class CounterActivity : AppCompatActivity() {

    // Instanciation magique : le framework gère la création et la conservation
    private val viewModel: CounterViewModel by viewModels()

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        // ...

        // On lit l'état depuis le ViewModel
        updateUi()

        binding.incrementButton.setOnClickListener {
            // On délègue l'action au ViewModel
            viewModel.increment()
            // On met à jour l'UI avec le nouvel état
            updateUi()
        }
    }

    private fun updateUi() {
        binding.counterTextView.text = viewModel.count.toString()
    }
}
</div><p id="z9fyyr4_146">Avec ce code, si vous faites pivoter l'&eacute;cran, la valeur du compteur sera conserv&eacute;e !</p></section><section class="chapter"><h3 id="exercice-1-refactoriser-le-compteur-en-mvvm" data-toc="exercice-1-refactoriser-le-compteur-en-mvvm">Exercice 1 : Refactoriser le compteur en MVVM</h3><p id="z9fyyr4_153"><span class="control" id="z9fyyr4_155">&Eacute;nonc&eacute; :</span> Reprenez le code du TP du module 4 (l'application &quot;Compteur&quot; qui perdait son &eacute;tat &agrave; la rotation) et refactorisez-le pour utiliser l'architecture MVVM.</p><ol class="list _decimal" id="z9fyyr4_154" type="1"><li class="list__item" id="z9fyyr4_156"><p id="z9fyyr4_160">Ajoutez la d&eacute;pendance <code class="code" id="z9fyyr4_161">lifecycle-viewmodel-ktx</code>.</p></li><li class="list__item" id="z9fyyr4_157"><p id="z9fyyr4_162">Cr&eacute;ez une classe <code class="code" id="z9fyyr4_163">CounterViewModel</code> qui contiendra la variable <code class="code" id="z9fyyr4_164">count</code> et la m&eacute;thode <code class="code" id="z9fyyr4_165">increment()</code>.</p></li><li class="list__item" id="z9fyyr4_158"><p id="z9fyyr4_166">Dans votre <code class="code" id="z9fyyr4_167">MainActivity</code>, instanciez le <code class="code" id="z9fyyr4_168">CounterViewModel</code> en utilisant <code class="code" id="z9fyyr4_169">by viewModels()</code>.</p></li><li class="list__item" id="z9fyyr4_159"><p id="z9fyyr4_170">Modifiez le code de l'Activity pour qu'elle lise l'&eacute;tat et appelle les m&eacute;thodes du ViewModel, au lieu de g&eacute;rer l'&eacute;tat elle-m&ecirc;me.</p></li></ol></section></section><section class="chapter"><div class="collapse"><div class="collapse__title"><h2 id="correction-exercice-1" data-toc="correction-exercice-1">Correction exercice 1</h2></div><div class="collapse__content"><p id="z9fyyr4_171"><span class="control" id="z9fyyr4_179">1. <code class="code" id="z9fyyr4_180">build.gradle.kts</code></span></p><div class="code-block" data-lang="kotlin">
dependencies {
    implementation(&quot;androidx.lifecycle:lifecycle-viewmodel-ktx:2.7.0&quot;)
    implementation(&quot;androidx.activity:activity-ktx:1.9.0&quot;) // pour by viewModels() dans une Activity
    // ...
}
</div><p id="z9fyyr4_173"><span class="control" id="z9fyyr4_181">2. <code class="code" id="z9fyyr4_182">CounterViewModel.kt</code></span></p><div class="code-block" data-lang="kotlin">
package fr.formation.compteurapp.viewmodel

import androidx.lifecycle.ViewModel

class CounterViewModel : ViewModel() {

    var count = 0
        private set

    fun incrementCounter() {
        count++
    }
}
</div><p id="z9fyyr4_175"><span class="control" id="z9fyyr4_183">3. <code class="code" id="z9fyyr4_184">MainActivity.kt</code></span></p><div class="code-block" data-lang="kotlin">
package fr.formation.compteurapp

import androidx.appcompat.app.AppCompatActivity
import android.os.Bundle
import androidx.activity.viewModels // Important
import fr.formation.compteurapp.databinding.ActivityMainBinding
import fr.formation.compteurapp.viewmodel.CounterViewModel

class MainActivity : AppCompatActivity() {

    private lateinit var binding: ActivityMainBinding

    // Délégation de l'instanciation du ViewModel au framework
    private val viewModel: CounterViewModel by viewModels()

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        binding = ActivityMainBinding.inflate(layoutInflater)
        setContentView(binding.root)

        // L'Activity ne fait plus que de l'affichage
        updateCounterText()

        binding.incrementButton.setOnClickListener {
            // L'Activity notifie le ViewModel de l'action de l'utilisateur
            viewModel.incrementCounter()
            // L'Activity met à jour son affichage en fonction du nouvel état
            updateCounterText()
        }
    }

    private fun updateCounterText() {
        // L'Activity lit l'état depuis le ViewModel
        binding.counterTextView.text = viewModel.count.toString()
    }
}
</div><p id="z9fyyr4_177">Maintenant, l'&eacute;tat du compteur survit &agrave; la rotation de l'&eacute;cran.</p></div></div></section><section class="chapter"><h2 id="tp-14-mettre-en-place-la-structure-mvvm-pour-notre-application-de-notes" data-toc="tp-14-mettre-en-place-la-structure-mvvm-pour-notre-application-de-notes">TP 14 : Mettre en place la structure MVVM pour notre application de notes</h2><p id="z9fyyr4_185"><span class="control" id="z9fyyr4_188">Objectif :</span> Pr&eacute;parer l'architecture de notre application de notes en cr&eacute;ant les diff&eacute;rentes couches du MVVM.</p><section class="procedure-steps" id="z9fyyr4_186"><ol class="list _decimal" id="z9fyyr4_189" type="1"><li class="list__item" id="z9fyyr4_190"><p id="z9fyyr4_193"><span class="control" id="z9fyyr4_196">Cr&eacute;ez la couche Model (Repository) :</span></p><ul class="list _bullet" id="z9fyyr4_194"><li class="list__item" id="z9fyyr4_197"><p id="z9fyyr4_201">Cr&eacute;ez une classe <code class="code" id="z9fyyr4_202">NoteRepository</code>.</p></li><li class="list__item" id="z9fyyr4_198"><p id="z9fyyr4_203">Pour l'instant, elle aura une d&eacute;pendance vers le <code class="code" id="z9fyyr4_204">NoteDao</code>.</p></li><li class="list__item" id="z9fyyr4_199"><p id="z9fyyr4_205">Cr&eacute;ez des m&eacute;thodes qui encapsulent les appels au DAO (ex: <code class="code" id="z9fyyr4_206">getAllNotes()</code>, <code class="code" id="z9fyyr4_207">insert(note: Note)</code>).</p></li><li class="list__item" id="z9fyyr4_200"><p id="z9fyyr4_208">Le but est que le ViewModel ne parle qu'au Repository, jamais directement au DAO.</p></li></ul><div class="code-block" data-lang="kotlin">
class NoteRepository(private val noteDao: NoteDao) {
    suspend fun getAllNotes(): List&lt;Note&gt; {
        return noteDao.getAllNotes()
    }

    suspend fun insert(note: Note) {
        noteDao.insert(note)
    }
}
</div></li><li class="list__item" id="z9fyyr4_191"><p id="z9fyyr4_209"><span class="control" id="z9fyyr4_211">Cr&eacute;ez la couche ViewModel :</span></p><ul class="list _bullet" id="z9fyyr4_210"><li class="list__item" id="z9fyyr4_212"><p id="z9fyyr4_214">Cr&eacute;ez un <code class="code" id="z9fyyr4_215">NoteViewModel</code> qui h&eacute;rite de <code class="code" id="z9fyyr4_216">ViewModel</code>.</p></li><li class="list__item" id="z9fyyr4_213"><p id="z9fyyr4_217">Le <code class="code" id="z9fyyr4_218">NoteViewModel</code> aura besoin d'une instance du <code class="code" id="z9fyyr4_219">NoteRepository</code>. Nous verrons plus tard comment l'injecter proprement, pour l'instant on peut le passer au constructeur.</p></li></ul></li><li class="list__item" id="z9fyyr4_192"><p id="z9fyyr4_220"><span class="control" id="z9fyyr4_222">R&eacute;fl&eacute;chissez &agrave; la communication :</span></p><ul class="list _bullet" id="z9fyyr4_221"><li class="list__item" id="z9fyyr4_223"><p id="z9fyyr4_225">Pour l'instant, notre <code class="code" id="z9fyyr4_226">MainActivity</code> appelle <code class="code" id="z9fyyr4_227">viewModel.increment()</code> puis <code class="code" id="z9fyyr4_228">updateUi()</code>. C'est un peu manuel. Ne serait-ce pas g&eacute;nial si l'UI se mettait &agrave; jour <span class="control" id="z9fyyr4_229">automatiquement</span> quand <code class="code" id="z9fyyr4_230">count</code> change ?</p></li><li class="list__item" id="z9fyyr4_224"><p id="z9fyyr4_231">C'est le probl&egrave;me que nous allons r&eacute;soudre dans le prochain module avec <code class="code" id="z9fyyr4_232">LiveData</code> et <code class="code" id="z9fyyr4_233">StateFlow</code>.</p></li></ul></li></ol><ol class="list _decimal"></ol></section></section><section class="chapter"><div class="collapse"><div class="collapse__title"><h2 id="correction-du-tp-14" data-toc="correction-du-tp-14">Correction du TP 14</h2></div><div class="collapse__content"><section class="chapter"><h3 id="pr-requis-la-couche-de-donn-es-room" data-toc="pr-requis-la-couche-de-donn-es-room">Pr&eacute;requis : La couche de Donn&eacute;es (Room)</h3><p id="z9fyyr4_240">Pour que ce TP fonctionne, nous avons besoin des classes <code class="code" id="z9fyyr4_244">Note</code>, <code class="code" id="z9fyyr4_245">NoteDao</code>, et <code class="code" id="z9fyyr4_246">AppDatabase</code> du TP pr&eacute;c&eacute;dent. Assurons-nous que les m&eacute;thodes du DAO sont des fonctions <code class="code" id="z9fyyr4_247">suspend</code>, car c'est la meilleure pratique pour Room avec les coroutines.</p><section class="chapter"><h4 id="note-kt-inchang" data-toc="note-kt-inchang"><code class="code" id="z9fyyr4_250">Note.kt</code> (inchang&eacute;)</h4><div class="code-block" data-lang="kotlin">
import androidx.room.Entity
import androidx.room.PrimaryKey

@Entity(tableName = &quot;note_table&quot;)
data class Note(
    @PrimaryKey(autoGenerate = true)
    val id: Int = 0,
    val title: String,
    val content: String
)
</div></section><section class="chapter"><h4 id="notedao-kt-modifi-pour-utiliser-suspend" data-toc="notedao-kt-modifi-pour-utiliser-suspend"><code class="code" id="z9fyyr4_254">NoteDao.kt</code> (modifi&eacute; pour utiliser <code class="code" id="z9fyyr4_255">suspend</code>)</h4><div class="code-block" data-lang="kotlin">
import androidx.room.*

@Dao
interface NoteDao {
    @Query(&quot;SELECT * FROM note_table ORDER BY id DESC&quot;)
    suspend fun getAllNotes(): List&lt;Note&gt; // &lt;-- Marqué suspend

    @Insert(onConflict = OnConflictStrategy.IGNORE)
    suspend fun insert(note: Note) // &lt;-- Marqué suspend
}
</div><ul class="list _bullet" id="z9fyyr4_253"><li class="list__item" id="z9fyyr4_256"><p id="z9fyyr4_257"><span class="control" id="z9fyyr4_258">Pourquoi <code class="code" id="z9fyyr4_261">suspend</code>?</span> En marquant ces fonctions comme <code class="code" id="z9fyyr4_259">suspend</code>, on indique &agrave; Kotlin que ce sont des op&eacute;rations potentiellement longues qui doivent &ecirc;tre appel&eacute;es depuis une coroutine. Room est optimis&eacute; pour cela et ex&eacute;cutera automatiquement la requ&ecirc;te sur un thread d'arri&egrave;re-plan. Cela nous permet de supprimer le <code class="code" id="z9fyyr4_260">.allowMainThreadQueries()</code> de notre base de donn&eacute;es, ce qui est une bien meilleure pratique.</p></li></ul></section><section class="chapter"><h4 id="appdatabase-kt-modifi-pour-retirer-allowmainthreadqueries" data-toc="appdatabase-kt-modifi-pour-retirer-allowmainthreadqueries"><code class="code" id="z9fyyr4_265">AppDatabase.kt</code> (modifi&eacute; pour retirer <code class="code" id="z9fyyr4_266">allowMainThreadQueries</code>)</h4><div class="code-block" data-lang="kotlin">
import android.content.Context
import androidx.room.*

@Database(entities = [Note::class], version = 1, exportSchema = false)
abstract class AppDatabase : RoomDatabase() {
    abstract fun noteDao(): NoteDao

    companion object {
        @Volatile
        private var INSTANCE: AppDatabase? = null

        fun getDatabase(context: Context): AppDatabase {
            return INSTANCE ?: synchronized(this) {
                val instance = Room.databaseBuilder(
                    context.applicationContext,
                    AppDatabase::class.java,
                    &quot;note_database&quot;
                )
                // On a retiré .allowMainThreadQueries() car on utilise des coroutines !
                .build()
                INSTANCE = instance
                instance
            }
        }
    }
}
</div></section></section><section class="chapter"><h3 id="correction-du-tp" data-toc="correction-du-tp">Correction du TP</h3></section><section class="chapter"><h3 id="tape-1-cr-er-la-couche-model-repository" data-toc="tape-1-cr-er-la-couche-model-repository">&Eacute;tape 1 : Cr&eacute;er la couche Model (Repository)</h3><p id="z9fyyr4_267">Cr&eacute;ez un nouveau fichier <code class="code" id="z9fyyr4_272">NoteRepository.kt</code>.</p><div class="code-block" data-lang="kotlin">
package com.example.yourapplication // Adaptez votre package

/**
 * Le Repository est une couche d'abstraction entre les sources de données (ici, le DAO)
 * et le reste de l'application (le ViewModel).
 * C'est le &quot;Single Source of Truth&quot; (source de vérité unique) pour les données.
 */
class NoteRepository(private val noteDao: NoteDao) {

    /**
     * Récupère toutes les notes via le DAO.
     * La fonction est 'suspend' car elle appelle une fonction 'suspend' du DAO.
     */
    suspend fun getAllNotes(): List&lt;Note&gt; {
        return noteDao.getAllNotes()
    }

    /**
     * Insère une note via le DAO.
     * La fonction est 'suspend' car elle appelle une fonction 'suspend' du DAO.
     */
    suspend fun insert(note: Note) {
        noteDao.insert(note)
    }
}
</div><p id="z9fyyr4_269"><span class="control" id="z9fyyr4_273">R&ocirc;le du Repository :</span></p><ul class="list _bullet" id="z9fyyr4_270"><li class="list__item" id="z9fyyr4_274"><p id="z9fyyr4_277">Il cache les d&eacute;tails de la provenance des donn&eacute;es (base de donn&eacute;es, r&eacute;seau, etc.).</p></li><li class="list__item" id="z9fyyr4_275"><p id="z9fyyr4_278">Il centralise la logique de donn&eacute;es. Si demain vous deviez synchroniser les notes avec un serveur, c'est ici que vous ajouteriez cette logique.</p></li><li class="list__item" id="z9fyyr4_276"><p id="z9fyyr4_279">Le <code class="code" id="z9fyyr4_280">ViewModel</code> ne saura jamais si les donn&eacute;es viennent d'une base de donn&eacute;es ou d'une API, il demande simplement les donn&eacute;es au <code class="code" id="z9fyyr4_281">Repository</code>.</p></li></ul></section><section class="chapter"><h3 id="tape-2-cr-er-la-couche-viewmodel" data-toc="tape-2-cr-er-la-couche-viewmodel">&Eacute;tape 2 : Cr&eacute;er la couche ViewModel</h3><section class="chapter"><h4 id="2a-d-pendances" data-toc="2a-d-pendances">2a. D&eacute;pendances</h4><p id="z9fyyr4_284">Assurez-vous d'avoir la d&eacute;pendance pour le ViewModel dans votre fichier <code class="code" id="z9fyyr4_286">build.gradle.kts</code>.</p><div class="code-block" data-lang="kotlin">
dependencies {
    // ...
    implementation(&quot;androidx.lifecycle:lifecycle-viewmodel-ktx:2.7.0&quot;)
}
</div></section><section class="chapter"><h4 id="2b-la-classe-noteviewmodel-kt" data-toc="2b-la-classe-noteviewmodel-kt">2b. La classe <code class="code" id="z9fyyr4_293">NoteViewModel.kt</code></h4><p id="z9fyyr4_288">Cr&eacute;ez un nouveau fichier <code class="code" id="z9fyyr4_294">NoteViewModel.kt</code>.</p><div class="code-block" data-lang="kotlin">
package com.example.yourapplication

import androidx.lifecycle.ViewModel
import androidx.lifecycle.viewModelScope
import kotlinx.coroutines.launch

/**
 * Le ViewModel sert de pont entre le Repository (données) et l'UI (View).
 * Il contient la logique métier et expose l'état de l'UI.
 * Il survit aux changements de configuration (comme la rotation de l'écran).
 */
class NoteViewModel(private val repository: NoteRepository) : ViewModel() {

    // On va stocker la liste des notes ici. Pour l'instant, c'est une simple variable.
    var notes: List&lt;Note&gt; = emptyList()

    /**
     * Charge les notes depuis le repository en utilisant les coroutines.
     * viewModelScope est un CoroutineScope lié au cycle de vie du ViewModel.
     * La coroutine sera automatiquement annulée si le ViewModel est détruit.
     */
    fun loadNotes() {
        viewModelScope.launch {
            notes = repository.getAllNotes()
        }
    }

    /**
     * Insère une nouvelle note via le repository.
     */
    fun addNote(note: Note) {
        viewModelScope.launch {
            repository.insert(note)
        }
    }
}
</div><p id="z9fyyr4_290"><span class="control" id="z9fyyr4_295">R&ocirc;le du ViewModel :</span></p><ul class="list _bullet" id="z9fyyr4_291"><li class="list__item" id="z9fyyr4_296"><p id="z9fyyr4_299">Il ne doit <span class="control" id="z9fyyr4_300">jamais</span> avoir de r&eacute;f&eacute;rence directe &agrave; une <code class="code" id="z9fyyr4_301">Activity</code> ou un <code class="code" id="z9fyyr4_302">Fragment</code> (pas de <code class="code" id="z9fyyr4_303">Context</code>).</p></li><li class="list__item" id="z9fyyr4_297"><p id="z9fyyr4_304">Il utilise <code class="code" id="z9fyyr4_305">viewModelScope</code> pour lancer des coroutines qui s'annulent automatiquement.</p></li><li class="list__item" id="z9fyyr4_298"><p id="z9fyyr4_306">Il d&eacute;tient les donn&eacute;es que l'UI doit afficher.</p></li></ul></section></section><section class="chapter"><h3 id="tape-3-r-flexion-sur-la-communication-et-exemple-de-code" data-toc="tape-3-r-flexion-sur-la-communication-et-exemple-de-code">&Eacute;tape 3 : R&eacute;flexion sur la Communication (et exemple de code)</h3><p id="z9fyyr4_307">Comme le souligne l'&eacute;nonc&eacute;, la communication est pour l'instant manuelle. Voici &agrave; quoi ressemblerait notre <code class="code" id="z9fyyr4_311">MainActivity</code> avec cette architecture. Elle montre clairement le probl&egrave;me.</p><p id="z9fyyr4_308">Pour que <code class="code" id="z9fyyr4_312">MainActivity</code> puisse cr&eacute;er un <code class="code" id="z9fyyr4_313">NoteViewModel</code> qui a besoin d'un <code class="code" id="z9fyyr4_314">NoteRepository</code>, nous devons utiliser une <span class="control" id="z9fyyr4_315">ViewModelFactory</span>. C'est le m&eacute;canisme standard pour injecter des d&eacute;pendances dans un ViewModel.</p><section class="chapter"><h4 id="noteviewmodelfactory-kt" data-toc="noteviewmodelfactory-kt"><code class="code" id="z9fyyr4_318">NoteViewModelFactory.kt</code></h4><div class="code-block" data-lang="kotlin">
import androidx.lifecycle.ViewModel
import androidx.lifecycle.ViewModelProvider

class NoteViewModelFactory(private val repository: NoteRepository) : ViewModelProvider.Factory {
    override fun &lt;T : ViewModel&gt; create(modelClass: Class&lt;T&gt;): T {
        if (modelClass.isAssignableFrom(NoteViewModel::class.java)) {
            @Suppress(&quot;UNCHECKED_CAST&quot;)
            return NoteViewModel(repository) as T
        }
        throw IllegalArgumentException(&quot;Unknown ViewModel class&quot;)
    }
}
</div></section><section class="chapter"><h4 id="mainactivity-kt-illustrant-le-probl-me" data-toc="mainactivity-kt-illustrant-le-probl-me"><code class="code" id="z9fyyr4_321">MainActivity.kt</code> (illustrant le probl&egrave;me)</h4><div class="code-block" data-lang="kotlin">
import androidx.appcompat.app.AppCompatActivity
import android.os.Bundle
import androidx.activity.viewModels
import androidx.lifecycle.lifecycleScope
import com.example.yourapplication.databinding.ActivityMainBinding
import kotlinx.coroutines.launch

class MainActivity : AppCompatActivity() {

    private lateinit var binding: ActivityMainBinding
    private lateinit var noteAdapter: NoteAdapter // On suppose que NoteAdapter existe

    // Injection de dépendances &quot;manuelle&quot; pour cet exemple
    private val database by lazy { AppDatabase.getDatabase(this) }
    private val repository by lazy { NoteRepository(database.noteDao()) }
    
    // Obtention du ViewModel via la factory
    private val noteViewModel: NoteViewModel by viewModels {
        NoteViewModelFactory(repository)
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        // ... initialisation du binding et de l'adapter ...

        loadAndDisplayNotes()

        binding.addButton.setOnClickListener {
            val title = binding.titleEditText.text.toString()
            val content = binding.contentEditText.text.toString()
            val newNote = Note(title = title, content = content)
            
            // On dit au ViewModel d'ajouter la note
            noteViewModel.addNote(newNote)
            
            // PROBLÈME : L'UI ne se met pas à jour toute seule.
            // On doit manuellement redemander les données et rafraîchir.
            // C'est inefficace et source d'erreurs.
            loadAndDisplayNotes() 
        }
    }

    private fun loadAndDisplayNotes() {
        // On doit utiliser une coroutine car le ViewModel met du temps à charger
        lifecycleScope.launch {
            noteViewModel.loadNotes() // Le VM charge les données dans sa variable interne
            // Il faut attendre un peu que la coroutine du VM se termine. Pas idéal !
            // (Ceci est une simplification pour l'exemple)
            noteAdapter.updateNotes(noteViewModel.notes) // On met à jour l'UI
        }
    }
}
</div></section></section><section class="chapter"><h3 id="conclusion-de-la-r-flexion" data-toc="conclusion-de-la-r-flexion">Conclusion de la r&eacute;flexion</h3><p id="z9fyyr4_322">Le code ci-dessus fonctionne, mais il met en lumi&egrave;re plusieurs probl&egrave;mes :</p><ol class="list _decimal" id="z9fyyr4_323" type="1"><li class="list__item" id="z9fyyr4_326"><p id="z9fyyr4_328"><span class="control" id="z9fyyr4_329">Communication manuelle :</span> L' <code class="code" id="z9fyyr4_330">Activity</code> doit explicitement appeler <code class="code" id="z9fyyr4_331">loadAndDisplayNotes()</code> pour rafra&icirc;chir l'interface. C'est l' <code class="code" id="z9fyyr4_332">Activity</code> qui &quot;tire&quot; (pulls) les donn&eacute;es.</p></li><li class="list__item" id="z9fyyr4_327"><p id="z9fyyr4_333"><span class="control" id="z9fyyr4_334">Probl&egrave;mes de synchronisation :</span> On lance une coroutine dans le <code class="code" id="z9fyyr4_335">ViewModel</code> et une autre dans l' <code class="code" id="z9fyyr4_336">Activity</code>. On n'est pas certain que les donn&eacute;es seront pr&ecirc;tes quand on mettra &agrave; jour l'adapter. C'est fragile.</p></li></ol><p id="z9fyyr4_324"><span class="control" id="z9fyyr4_337">La solution</span>, comme mentionn&eacute; dans le TP, est de rendre les donn&eacute;es <span class="control" id="z9fyyr4_338">observables</span>. L' <code class="code" id="z9fyyr4_339">Activity</code> ne demandera plus les donn&eacute;es. Elle s' <span class="control" id="z9fyyr4_340">abonnera</span> aux changements. Quand les donn&eacute;es changeront dans le <code class="code" id="z9fyyr4_341">ViewModel</code>, celui-ci &quot;poussera&quot; (pushes) automatiquement la nouvelle liste vers l' <code class="code" id="z9fyyr4_342">Activity</code>, qui n'aura plus qu'&agrave; mettre &agrave; jour son <code class="code" id="z9fyyr4_343">RecyclerView</code>.</p><p id="z9fyyr4_325">C'est exactement le r&ocirc;le de <code class="code" id="z9fyyr4_344">LiveData</code> et de <code class="code" id="z9fyyr4_345">StateFlow</code> que vous verrez par la suite. Ce TP a parfaitement pr&eacute;par&eacute; le terrain en montrant la n&eacute;cessit&eacute; de ces outils.</p></section></div></div></section><section class="chapter"><h2 id="auto-valuation" data-toc="auto-valuation">Auto-&eacute;valuation</h2><p id="z9fyyr4_346"><span class="control" id="z9fyyr4_355">1. Quelle est la responsabilit&eacute; principale de la couche &quot;View&quot; dans l'architecture MVVM ? (QCM)</span></p><ul class="list _bullet" id="z9fyyr4_347"><li class="list__item" id="z9fyyr4_356"><p id="z9fyyr4_360">A) Effectuer les appels r&eacute;seau et les requ&ecirc;tes en base de donn&eacute;es.</p></li><li class="list__item" id="z9fyyr4_357"><p id="z9fyyr4_361">B) Contenir la logique m&eacute;tier et les d&eacute;cisions complexes.</p></li><li class="list__item" id="z9fyyr4_358"><p id="z9fyyr4_362">C) Afficher l'&eacute;tat de l'UI et transmettre les interactions de l'utilisateur au ViewModel.</p></li><li class="list__item" id="z9fyyr4_359"><p id="z9fyyr4_363">D) Stocker l'&eacute;tat de l'UI de mani&egrave;re persistante.</p></li></ul><p id="z9fyyr4_348"><span class="control" id="z9fyyr4_364">2. Quel est l'avantage majeur du composant <code class="code" id="z9fyyr4_365">ViewModel</code> de Jetpack ? (QCM)</span></p><ul class="list _bullet" id="z9fyyr4_349"><li class="list__item" id="z9fyyr4_366"><p id="z9fyyr4_370">A) Il acc&eacute;l&egrave;re les requ&ecirc;tes en base de donn&eacute;es.</p></li><li class="list__item" id="z9fyyr4_367"><p id="z9fyyr4_371">B) Il survit aux changements de configuration, prot&eacute;geant ainsi l'&eacute;tat de l'UI.</p></li><li class="list__item" id="z9fyyr4_368"><p id="z9fyyr4_372">C) Il simplifie l'&eacute;criture des layouts XML.</p></li><li class="list__item" id="z9fyyr4_369"><p id="z9fyyr4_373">D) Il g&egrave;re automatiquement la navigation entre les fragments.</p></li></ul><p id="z9fyyr4_350"><span class="control" id="z9fyyr4_374">3. Lequel de ces &eacute;l&eacute;ments ne devrait JAMAIS se trouver dans un <code class="code" id="z9fyyr4_375">ViewModel</code>? (QCM)</span></p><ul class="list _bullet" id="z9fyyr4_351"><li class="list__item" id="z9fyyr4_376"><p id="z9fyyr4_380">A) Une r&eacute;f&eacute;rence &agrave; un Repository.</p></li><li class="list__item" id="z9fyyr4_377"><p id="z9fyyr4_381">B) Des donn&eacute;es d'&eacute;tat de l'interface (comme une liste d'items &agrave; afficher).</p></li><li class="list__item" id="z9fyyr4_378"><p id="z9fyyr4_382">C) Une r&eacute;f&eacute;rence directe &agrave; une Activity ou un Fragment (un <code class="code" id="z9fyyr4_383">Context</code>).</p></li><li class="list__item" id="z9fyyr4_379"><p id="z9fyyr4_384">D) La logique pour formater une date &agrave; afficher.</p></li></ul><p id="z9fyyr4_352"><span class="control" id="z9fyyr4_385">4. Expliquez avec vos mots le principe de &quot;S&eacute;paration des Pr&eacute;occupations&quot;. (Question ouverte)</span></p><p id="z9fyyr4_353">**5. Quel probl&egrave;me fondamental l'architecture MVVM r&eacute;sout-elle concernant le cycle de vie d'Android ? (Question ouverte) **</p><section class="chapter"><div class="collapse"><div class="collapse__title"><h3 id="correction-de-l-auto-valuation" data-toc="correction-de-l-auto-valuation">Correction de l'auto-&eacute;valuation</h3></div><div class="collapse__content"><p id="z9fyyr4_386"><span class="control" id="z9fyyr4_397">1. Quelle est la responsabilit&eacute; principale de la couche &quot;View&quot; ?</span></p><ul class="list _bullet" id="z9fyyr4_387"><li class="list__item" id="z9fyyr4_398"><p id="z9fyyr4_400"><span class="control" id="z9fyyr4_401">R&eacute;ponse : C) Afficher l'&eacute;tat de l'UI et transmettre les interactions de l'utilisateur au ViewModel.</span></p></li><li class="list__item" id="z9fyyr4_399"><p id="z9fyyr4_402"><span class="control" id="z9fyyr4_403">Justification :</span> La View doit &ecirc;tre aussi &quot;b&ecirc;te&quot; que possible. Son r&ocirc;le est de traduire un &eacute;tat (fourni par le ViewModel) en pixels &agrave; l'&eacute;cran, et de traduire les actions de l'utilisateur (clics, etc.) en appels de m&eacute;thode sur le ViewModel.</p></li></ul><p id="z9fyyr4_388"><span class="control" id="z9fyyr4_404">2. Quel est l'avantage majeur du composant <code class="code" id="z9fyyr4_405">ViewModel</code>?</span></p><ul class="list _bullet" id="z9fyyr4_389"><li class="list__item" id="z9fyyr4_406"><p id="z9fyyr4_408"><span class="control" id="z9fyyr4_409">R&eacute;ponse : B) Il survit aux changements de configuration, prot&eacute;geant ainsi l'&eacute;tat de l'UI.</span></p></li><li class="list__item" id="z9fyyr4_407"><p id="z9fyyr4_410"><span class="control" id="z9fyyr4_411">Justification :</span> Son cycle de vie est d&eacute;coupl&eacute; de celui de la View (Activity/Fragment), ce qui lui permet de conserver les donn&eacute;es en m&eacute;moire lors de la recr&eacute;ation de l'UI, comme lors d'une rotation d'&eacute;cran.</p></li></ul><p id="z9fyyr4_390"><span class="control" id="z9fyyr4_412">3. Lequel de ces &eacute;l&eacute;ments ne devrait JAMAIS se trouver dans un <code class="code" id="z9fyyr4_413">ViewModel</code>?</span></p><ul class="list _bullet" id="z9fyyr4_391"><li class="list__item" id="z9fyyr4_414"><p id="z9fyyr4_416"><span class="control" id="z9fyyr4_417">R&eacute;ponse : C) Une r&eacute;f&eacute;rence directe &agrave; une Activity ou un Fragment (un <code class="code" id="z9fyyr4_418">Context</code>).</span></p></li><li class="list__item" id="z9fyyr4_415"><p id="z9fyyr4_419"><span class="control" id="z9fyyr4_420">Justification :</span> D&eacute;tenir une r&eacute;f&eacute;rence &agrave; une View dans un ViewModel est une source majeure de fuites de m&eacute;moire. Comme le ViewModel a une dur&eacute;e de vie plus longue que la View, il l'emp&ecirc;cherait d'&ecirc;tre d&eacute;truite et nettoy&eacute;e par le &quot; garbage collector&quot;, m&ecirc;me quand l'utilisateur a quitt&eacute; l'&eacute;cran.</p></li></ul><p id="z9fyyr4_392"><span class="control" id="z9fyyr4_421">4. Expliquez le principe de &quot;S&eacute;paration des Pr&eacute;occupations&quot;.</span></p><ul class="list _bullet" id="z9fyyr4_393"><li class="list__item" id="z9fyyr4_422"><p id="z9fyyr4_423"><span class="control" id="z9fyyr4_424">R&eacute;ponse type :</span> C'est le principe de conception logicielle qui consiste &agrave; d&eacute;couper un programme en parties distinctes, o&ugrave; chaque partie s'occupe d'un aspect sp&eacute;cifique du probl&egrave;me. Dans MVVM, la View ne se pr&eacute;occupe que de l'affichage, le ViewModel de la logique de pr&eacute;sentation, et le Model de la source des donn&eacute;es. Cette s&eacute;paration rend le code plus facile &agrave; comprendre, &agrave; tester et &agrave; faire &eacute;voluer, car un changement dans une partie (par exemple, changer la base de donn&eacute;es) a moins de chances d'impacter les autres.</p></li></ul><p id="z9fyyr4_394"><span class="control" id="z9fyyr4_425">5. Quel probl&egrave;me fondamental MVVM r&eacute;sout-il concernant le cycle de vie d'Android ?</span></p><ul class="list _bullet" id="z9fyyr4_395"><li class="list__item" id="z9fyyr4_426"><p id="z9fyyr4_427"><span class="control" id="z9fyyr4_428">R&eacute;ponse type :</span> Il r&eacute;sout le probl&egrave;me de la <span class="control" id="z9fyyr4_429">perte d'&eacute;tat</span> due &agrave; la destruction et recr&eacute;ation des composants UI ( Activity/Fragment) lors des changements de configuration. En d&eacute;pla&ccedil;ant la responsabilit&eacute; de la gestion de l'&eacute;tat de la View (qui a un cycle de vie volatile) vers le <code class="code" id="z9fyyr4_430">ViewModel</code> (qui a un cycle de vie stable et plus long), l'architecture garantit que les donn&eacute;es affich&eacute;es &agrave; l'&eacute;cran sont pr&eacute;serv&eacute;es de mani&egrave;re fiable, am&eacute;liorant ainsi consid&eacute;rablement l'exp&eacute;rience utilisateur.</p></li></ul></div></div></section></section><section class="chapter"><h2 id="conclusion-du-module" data-toc="conclusion-du-module">Conclusion du module</h2><p id="z9fyyr4_431">Vous avez pos&eacute; les fondations de votre architecture ! Vous comprenez maintenant l'importance de structurer votre code et vous savez comment mettre en place les diff&eacute;rentes couches du pattern MVVM. Vous avez r&eacute;solu le probl&egrave;me de la perte d'&eacute;tat gr&acirc;ce au <code class="code" id="z9fyyr4_433">ViewModel</code> de Jetpack.</p><p id="z9fyyr4_432">Cependant, la communication entre notre View et notre ViewModel est encore un peu &quot;manuelle&quot;. La View doit explicitement demander au ViewModel de mettre &agrave; jour l'UI. Dans le prochain et dernier module de contenu, nous allons d&eacute;couvrir comment rendre cette communication <span class="control" id="z9fyyr4_434">r&eacute;active</span> avec <code class="code" id="z9fyyr4_435">LiveData</code> et <code class="code" id="z9fyyr4_436">StateFlow</code>, pour que l'UI se mette &agrave; jour * <span class="emphasis" id="z9fyyr4_437">automatiquement</span>* comme par magie. C'est la derni&egrave;re pi&egrave;ce du puzzle pour une architecture MVVM compl&egrave;te et moderne.</p></section><div class="last-modified">31 octobre 2025</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom"><a href="005-partie-05.html" class="navigation-links__prev">Partie 5 : Architecture et Finalisation</a><a href="005-02-module-15.html" class="navigation-links__next">Module 15 : Communication R&eacute;active avec `LiveData` et `StateFlow`</a></div></article><div id="disqus_thread"></div></div></section></main></div><script src="https://resources.jetbrains.com/writerside/apidoc/6.22.0-b776/app.js"></script></body></html>